
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WearTrack POS</title>
<style>
/* ---------- PASTEL BLUE THEME + layout ---------- */
:root{
 /* EXISTING VARIABLES */
 --bg: #e6f3ff;
 --card: #ffffff;
 --primary: #7fb7ff;
 --primary-dark: #5ea8ff;
 --muted: #5a6b7a;
 --danger: #ff6b6b;
 --success: #4cd964; 
 --accent-ghost: #dff1ff;
 --border: #cfe9ff;  
 --text-main: #334e68; 

 /* NEW VARIABLES FOR TICKETS */
 --ticket-border: #cfe9ff;
 --ticket-shadow: rgba(0,0,0,0.02);
 --ticket-hover-shadow: rgba(0,0,0,0.08);
}

* { box-sizing: border-box;}

input,
select,
textarea {
  font-size: 16px;
}

body {
 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 margin:0; padding:0;
 background: var(--bg);
 color: var(--muted);
 -webkit-font-smoothing:antialiased;
}

.container { max-width:1200px; margin:auto; padding:10px; }

h2, h3 { text-align:center; color: #4d8ed3; margin:8px 0; }
button {
 padding:6px 12px; border:none; border-radius:6px;
 background:var(--primary); color:white; cursor:pointer; transition:0.16s;
 box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}
button:hover { background:var(--primary-dark); transform: translateY(-1px); }
input, select {
 width:100%; padding:10px; margin:6px 0;
 border:1px solid #cfe9ff; border-radius:6px;
 background: white;
}
.hidden { display:none; }

/* ---------- SECTIONS ---------- */
.section { margin-top:18px; }

/* =========================================
   NEW INVENTORY CARD DESIGN (MATCHING PHOTO)
   ========================================= */
.inventory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.inventory-card {
    background: var(--card);
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    gap: 15px;
    border: 1px solid var(--border);
    transition: transform 0.2s ease;
}

.inventory-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(127, 183, 255, 0.15);
}

/* Card Top: Badge and Price */
.inv-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.inv-badge {
    font-size: 11px;
    font-weight: 800;
    text-transform: uppercase;
    padding: 6px 12px;
    border-radius: 8px;
    letter-spacing: 0.5px;
}

.inv-price {
    font-size: 20px;
    font-weight: 800;
    color: var(--text-main);
}

/* Card Body: Name */
.inv-name {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-main);
    margin-top: -5px;
    min-height: 40px; /* Aligns cards if lines wrap */
}

/* Stock Bar Area */
.inv-stock-container {
    margin-top: auto;
}

.inv-stock-labels {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    margin-bottom: 6px;
    font-weight: 600;
}

.stock-label-text { color: var(--muted); opacity: 0.8; }
.stock-val-text { font-weight: 700; }

.stock-bar-bg {
    width: 100%;
    height: 6px;
    background: #f1f5f9;
    border-radius: 10px;
    overflow: hidden;
}

.stock-bar-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
}

/* Action Buttons */
.inv-actions {
    display: flex;
    gap: 12px;
    margin-top: 5px;
}

.inv-btn {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: 0.2s;
    box-shadow: none;
}

.inv-btn-edit {
    background: #e0f2fe;
    color: #0284c7;
}
.inv-btn-edit:hover { background: #bae6fd; }

.inv-btn-del {
    background: white;
    border: 1px solid #fee2e2;
    color: #ef4444;
}
.inv-btn-del:hover { background: #fef2f2; }

/* Badge Colors */
.badge-sport { background: #e0f2fe; color: #0284c7; }
.badge-silver { background: #f1f5f9; color: #475569; }
.badge-indu { background: #fff7ed; color: #c2410c; }

/* Stock Colors */
.stock-green { color: #4cd964; }
.bar-green { background: #4cd964; }

.stock-yellow { color: #f59e0b; }
.bar-yellow { background: #f59e0b; }

.stock-red { color: #ef4444; }
.bar-red { background: #ef4444; }

/* =========================================
   CASHIER CARD STYLES
   ========================================= */
.cashier-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.cashier-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 4px 12px rgba(127, 183, 255, 0.15);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    position: relative;
    overflow: hidden;
}

.cashier-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(127, 183, 255, 0.25);
    border-color: var(--primary);
}

/* Header (Avatar + Info) */
.card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.avatar {
    width: 48px;
    height: 48px;
    min-width: 48px;
    background: linear-gradient(135deg, #e6f3ff 0%, #cfe9ff 100%);
    color: var(--primary-dark);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 18px;
    border: 2px solid white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

.info {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.username {
    font-weight: 700;
    font-size: 16px;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Status Badges */
.status-badge {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 3px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.status-active { color: var(--success); }
.status-active::before {
    content: ''; display: block; width: 6px; height: 6px; 
    background: var(--success); border-radius: 50%;
    box-shadow: 0 0 0 2px rgba(76, 217, 100, 0.2);
}

.status-disabled { color: var(--danger); }
.status-disabled::before {
    content: ''; display: block; width: 6px; height: 6px; 
    background: var(--danger); border-radius: 50%;
}

/* Disabled Card State */
.cashier-card.is-disabled {
    background: #f8fafc;
    opacity: 0.8;
}
.cashier-card.is-disabled .avatar {
    filter: grayscale(100%);
    opacity: 0.7;
}

/* Action Buttons */
.card-actions {
    display: flex;
    gap: 8px;
    padding-top: 12px;
    border-top: 1px dashed var(--border);
}

.action-btn {
    flex: 1;
    padding: 10px 0;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: none; /* Reset global shadow */
}

/* Button Variants */
.btn-toggle { background: #e0f2fe; color: #0284c7; }
.btn-toggle:hover { background: #bae6fd; transform: translateY(-1px); }

.btn-toggle.enable-state { background: #dcfce7; color: #166534; }
.btn-toggle.enable-state:hover { background: #bbf7d0; transform: translateY(-1px); }

.btn-edit { background: #f1f5f9; color: #475569; }
.btn-edit:hover { background: #e2e8f0; transform: translateY(-1px); }

.btn-delete {
    background: #fee2e2;
    color: #991b1b;
    flex: 0 0 40px; 
    font-size: 18px;
}
.btn-delete:hover { background: #fecaca; transform: translateY(-1px); }

/* =========================================
   END CASHIER CARD STYLES
   ========================================= */

/* ---------- POS LAYOUT ---------- */
#pos { display:flex; flex-wrap:wrap; gap:12px; margin-top:10px; align-items:flex-start; }
#productGrid {
 display:grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); 
 gap:12px; flex:2; max-height:640px; overflow-y:auto; padding-right:6px; ;
}

/* ========== NEW PRODUCT CARD DESIGN (GRID ITEMS) ========== */
.product {
  background: var(--card);
  border-radius: 16px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.04);
  padding: 12px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  height: 150px;
  position: relative;
  transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  border: 1px solid transparent;
  cursor: pointer;
  overflow: hidden;
}

.product:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.08);
  border-color: var(--primary);
}

.product-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.category-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--accent-ghost);
    color: var(--primary-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 800;
    text-transform: uppercase;
}

.stock-pill {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: 700;
}
.stock-high { background: #d1fae5; color: #065f46; } 
.stock-low  { background: #ffedd5; color: #9a3412; } 
.stock-out  { background: #fee2e2; color: #991b1b; } 

.product-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--muted);
    line-height: 1.3;
    margin-bottom: auto;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-align: left;
}

.product-price {
    font-size: 18px;
    font-weight: 800;
    color: var(--primary-dark);
    text-align: right;
    margin-top: 4px;
}

/* ========== CUSTOM TRANSACTION CARD ========== */
.custom-product {
    border: 2px dashed #cbd5e1;
    box-shadow: none;
    background: transparent !important;
    justify-content: center;
    align-items: center;
    color: var(--primary);
}

.custom-product:hover {
    background: var(--accent-ghost) !important;
    border-color: var(--primary);
}

.custom-content { text-align: center; }
.custom-icon { font-size: 32px; line-height: 1; margin-bottom: 4px; font-weight: 300; }

/* ============================================= */

#cart {
  flex:1.5; background:var(--card); padding:12px; border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.06); max-height:640px; display:flex; flex-direction:column;
  min-width:250px;
}
#cart table { width:100%; border-collapse:collapse; margin-bottom:12px; }
#cart th, #cart td { border-bottom:1px solid #eef6ff; padding:6px; text-align:left; font-size:14px; color:var(--muted); }
#cart th { background:var(--accent-ghost); }

/* ---------- MODAL ---------- */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.35); justify-content:center; align-items:center; z-index:8000; }
.modal-content { background:var(--card); padding:18px; border-radius:12px; width:92%; max-width:420px; box-shadow:0 8px 24px rgba(0,0,0,0.12); }
.qty-buttons { display:flex; align-items:center; gap:6px; }
.qty-buttons button { width:34px; }

/* ---------- CATEGORY BUTTONS ---------- */
#adminCategoryButtons button, #cashierCategoryButtons button { margin-right:6px; margin-bottom:8px; background:var(--primary); }
#adminCategoryButtons button:hover, #cashierCategoryButtons button:hover { background:var(--primary-dark); }

#cashierCategoryButtons button {
  background: transparent;
  border: 2px solid var(--primary);
  color: var(--primary-dark);
  font-weight: 600;
}

#cashierCategoryButtons button.active-cat {
  background: var(--primary-dark);
  color: white;
  border-color: var(--primary-dark);
}

.cashier-tab{
   padding-left: 10px;
   padding-right: 10px;
   border: #d9d9d9b1 1px solid;
   border-radius: 12px;
   height: 50px;
   margin-bottom: 8px;
   display:flex;
   justify-content: space-between;
   align-items: center;
}

.menuBtn{ width: 20px; }
#side-panel, #adminPanel{
   position: fixed;
   right: -500px;
   top: 0;
   bottom: 0;
   width: 300px;
   background-color: var(--muted);
   z-index: 8000;
   transition: right 0.3s ease-in-out;
}

#side-panel.active, #adminPanel.active{ right: 0; }

.panel-btn, .admin-btn{
   display: flex;
   flex-direction: column;
   gap: 10px;
   padding: 0 8px;
}
.panel-btn button, .admin-btn button{ height: 50px; }

/* ---------- ADMIN CATEGORY BUTTONS ACTIVE (ADMIN) ---------- */
#adminCategoryButtons {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin: 15px 0;
}

#adminCategoryButtons button {
  background: transparent;
  border: 2px solid var(--primary);
  color: var(--primary-dark);
  font-weight: 600;
  padding: 8px 14px;
  border-radius: 8px;
  box-shadow: none;
}

#adminCategoryButtons button:hover { background: var(--accent-ghost); }

#adminCategoryButtons button.active-cat {
  background: var(--primary-dark);
  color: white;
  border-color: var(--primary-dark);
}

/* ---------- DAILY SALES CATEGORY BUTTONS ACTIVE ---------- */
#dailyCategoryButtons {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-bottom: 10px;
}

#dailyCategoryButtons button {
  background: transparent;
  border: 2px solid var(--primary);
  color: var(--primary-dark);
  font-weight: 600;
  padding: 6px 14px;
  border-radius: 8px; 
  box-shadow: none;
}

#dailyCategoryButtons button:hover { background: var(--accent-ghost); }

#dailyCategoryButtons button.active-cat {
  background: var(--primary-dark);
  color: white;
  border-color: var(--primary-dark);
}

/* =================================================================
   NEW TICKET CARD STYLES (INTEGRATED)
   ================================================================= */
.sale-ticket {
    background: var(--card);
    color: var(--muted);
    border: 1px solid var(--ticket-border);
    border-radius: 12px;
    margin-bottom: 15px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 4px 6px var(--ticket-shadow);
}

.sale-ticket:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 15px var(--ticket-hover-shadow);
    border-color: var(--primary);
}

/* Ticket Header */
.ticket-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 12px 16px;
    border-bottom: 2px dashed rgba(0,0,0,0.08);
    background: rgba(127, 183, 255, 0.05); /* very faint primary tint */
}

.ticket-meta {
    display: flex;
    flex-direction: column;
}

.meta-time {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    opacity: 0.7;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
}

.meta-cashier {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary-dark);
}

/* New Ticket Delete Button */
.btn-delete-ticket {
    background: transparent;
    border: none;
    color: #ccc;
    font-size: 18px;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    line-height: 1;
    transition: 0.2s;
    box-shadow: none; /* Override general button shadow */
}
.btn-delete-ticket:hover {
    background: #fee2e2;
    color: var(--danger);
    transform: none; /* Override general button hover */
}

/* Ticket Body */
.ticket-body {
    padding: 14px 16px;
}

.ticket-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 14px;
}

.item-info {
    display: flex;
    align-items: center;
    gap: 8px;
}

.item-qty {
    font-size: 12px;
    opacity: 0.6;
}

/* Badges */
.badge {
    font-size: 10px;
    padding: 3px 6px;
    border-radius: 4px;
    font-weight: 700;
    text-transform: uppercase;
}

/* Light Mode Badge Colors */
.badge.sport { background: #e0f2fe; color: #0284c7; }
.badge.silver { background: #f1f5f9; color: #475569; }
.badge.indu  { background: #fff7ed; color: #ea580c; }
.badge.other { background: #eef; color: #666; }

/* Ticket Footer */
.ticket-footer {
    padding: 12px 16px;
    background: rgba(0,0,0,0.02);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid rgba(0,0,0,0.05);
}

.total-label {
    font-size: 12px;
    font-weight: 600;
    opacity: 0.7;
}

.total-price {
    font-size: 18px;
    font-weight: 800;
    color: var(--primary-dark);
}

/* =================================================================
   RESPONSIVE & DARK THEME
   ================================================================= */
@media(max-width:900px){
 #pos { flex-direction:column; gap:10px; }
 #productGrid { max-height:none; width:100%; }
 #cart { max-height:none; width:100%; margin-top:10px;}
}

/* --- Added Mobile Fix for Cashier Grid --- */
@media (max-width: 768px) {
    .container { padding: 10px; } /* Slightly reduce padding */
    .cashier-grid {
        grid-template-columns: 1fr; /* Force single column on mobile */
        gap: 16px;
    }
}

/* Dark theme support */
body.dark-theme #side-panel{
   background-color: #515151;
}

body.dark-theme  {
  --bg: #121212;
  --card: #1e1e1e;
  --primary: #4a90e2;
  --primary-dark: #357ab7;
  --muted: #8e8e8e;
  --danger: #ff6b6b;
  --accent-ghost: #2a2a2a;
  
  /* Ticket variables for Dark Mode */
  --ticket-border: #333333;
  --ticket-shadow: rgba(0,0,0,0.2);
  --ticket-hover-shadow: rgba(0,0,0,0.3);
  
  /* Cashier Card Dark Mode */
  --border: #333333;
  --text-main: #e0e0e0;

  color: var(--muted);
  background: var(--bg);
}

body.dark-theme input,
body.dark-theme select {
  background: #2a2a2a;
  color: #fff;
  border: 1px solid #444;
}

body.dark-theme button {
  color: white;
}

body.dark-theme #cart,
body.dark-theme #productGrid .product,
/* body.dark-theme #inventoryList div { -- REMOVED THIS SELECTOR AS WE HAVE NEW STRUCTURE */
body.dark-theme .inventory-card { /* Added for new inventory */
  background: var(--card);
  color: var(--muted);
  border-color: var(--border);
}

/* Dark Theme Overrides for Cashier Card */
body.dark-theme .cashier-card:hover {
    background: #252525;
    border-color: var(--primary);
}
body.dark-theme .avatar {
    background: #2a2a2a;
    border-color: #333;
    color: var(--primary);
}
body.dark-theme .cashier-card.is-disabled {
    background: #141414;
    border-color: #222;
    opacity: 0.6;
}

body.dark-theme .btn-toggle { background: #0c4a6e; color: #bae6fd; }
body.dark-theme .btn-toggle:hover { background: #075985; }
body.dark-theme .btn-toggle.enable-state { background: #064e3b; color: #a7f3d0; }
body.dark-theme .btn-toggle.enable-state:hover { background: #065f46; }
body.dark-theme .btn-edit { background: #334155; color: #cbd5e1; }
body.dark-theme .btn-edit:hover { background: #475569; }
body.dark-theme .btn-delete { background: #450a0a; color: #fca5a5; }
body.dark-theme .btn-delete:hover { background: #7f1d1d; }


/* Dark theme specific overrides for custom card */
body.dark-theme .custom-product {
    border-color: #444;
}
body.dark-theme .custom-product:hover {
    background: #2a2a2a !important;
}

/* Dark Theme Overrides for New Ticket */
body.dark-theme .sale-ticket {
    background: var(--card);
    border-color: var(--ticket-border);
}

body.dark-theme .ticket-header {
    border-bottom-color: rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.03);
}

body.dark-theme .ticket-footer {
    background: rgba(255,255,255,0.03);
    border-top-color: rgba(255,255,255,0.1);
}

body.dark-theme .btn-delete-ticket:hover {
    background: rgba(255, 107, 107, 0.2);
}

body.dark-theme .badge.sport { background: #0c4a6e; color: #bae6fd; }
body.dark-theme .badge.silver { background: #334155; color: #cbd5e1; }
body.dark-theme .badge.indu  { background: #431407; color: #fed7aa; }

/* =========================================
   DARK THEME UPDATES FOR NEW INVENTORY
   ========================================= */
body.dark-theme .stock-bar-bg { background: #333; }
body.dark-theme .inv-btn-edit { background: #1e293b; color: #38bdf8; }
body.dark-theme .inv-btn-edit:hover { background: #334155; }
body.dark-theme .inv-btn-del { background: transparent; border-color: #7f1d1d; color: #f87171; }
body.dark-theme .inv-btn-del:hover { background: #450a0a; }

/* Dark Mode Badges for Inventory */
body.dark-theme .badge-sport { background: #0c4a6e; color: #38bdf8; }
body.dark-theme .badge-silver { background: #1e293b; color: #94a3b8; }
body.dark-theme .badge-indu { background: #431407; color: #fb923c; }

</style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="container">
 <h2>Densio POS Login</h2>
  <input type="text" id="username" placeholder="Username">
 <input type="password" id="password" placeholder="Password">
 <button onclick="login()" style="width:100%; height:50px; margin-top:15px">Login</button>
 <p id="loginMsg" style="color:crimson;"></p>
</div>

<!-- ADMIN PAGE -->
<div id="adminPage" class="container hidden">
   <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>Admin Dashboard</h2>
    <button onclick="adminPanel()">
       <img src="Image/Menu.png" alt="Image/Menu.png" class="menuBtn">
    </button>
   </div>
   <div id="adminPanel" style="display:flex; justify-content:space-between; flex-direction:column;">
      <div>
            <div style="display:flex; justify-content:end; margin: 10px;">
            <button onclick="adminPanel()" style="width:40px; height:40px;">X</button>
            </div>
         <div class="admin-btn">
          <button onclick="showSection('inventory')">Inventory</button>
          <button onclick="showSection('cashiers')">Cashiers</button>
          <button onclick="showSection('salesSummary')">Sales Summary</button>
          <button onclick="showSection('settings')">Settings</button>
          <button onclick="showSection('reports')">Reports</button>
          <button onclick="logout()">Logout</button>
         </div>
      </div>
      <div style="color:#ffffffb1; display:flex; justify-content:space-between; padding:10px">
         <small>v5.0.2.23 beta</small>
         <small>Dev:jeypsss</small>
      </div>
   </div>

 <div id="inventory" class="hidden section">
   <h3>Inventory</h3>
   <button onclick="toggleAddProduct()">Add Product</button>
   <div id="addProductForm" class="hidden">
    <input type="text" id="prodName" placeholder="Product Name">
      <select id="prodCat">
        <option value="">Select Category</option>
        <option value="Sportswear">Sportswear</option>
        <option value="Silver">Silver</option>
        <option value="Indu">Indu</option>
     </select>
     <input type="number" id="prodPrice" placeholder="Price">
     <input type="number" id="prodStock" placeholder="Stock Quantity">
Â  Â  Â  <button onclick="addProduct()">Add</button>
Â  Â  </div>
    <!-- UPDATED: Added inventory-grid class -->
Â  Â  <div id="inventoryList" class="inventory-grid"></div>
Â  </div>

Â  <div id="cashiers" class="hidden section">
Â  Â  <h3>Cashiers</h3>
Â  Â  <input type="text" id="cashierName" placeholder="Cashier Username">
Â  Â  <input type="password" id="cashierPass" placeholder="Password">
Â  Â  <button onclick="addCashier()" style="margin-bottom:10px; height:40px; width:100%">Add Cashier</button>
   <!-- UPDATED CASHIER LIST CONTAINER (GRID) -->
   <div id="cashierList" class="cashier-grid"></div>
 </div>

  <div id="salesSummary" class="hidden section">
Â  Â  <h3>Sales Summary</h3>
   <div style="display:flex; gap:10px; margin-bottom:10px;">
  <div style="flex:1;">
    <label>From:</label>
    <select id="adminDateFrom"></select>
  </div>
  <div style="flex:1;">
    <label>To:</label>
    <select id="adminDateTo"></select>
  </div>
</div>

<div style="margin-bottom:10px;">
  <label>Cashier:</label>
  <select id="adminCashierFilter">
    <option value="All">All Cashiers</option>
  </select>
</div>


<div id="adminCategoryButtons"></div>
<div id="adminGrandTotal" style="font-weight:800; margin:20px 0;">Total: â‚±0</div>
<div id="salesList"></div>
Â  </div>

  <div id="settings" class="hidden section">
     <h3>POS Settings</h3>
     <div id="settingsList" style="display:flex; flex-direction:column; gap:10px;"></div>
   </div>
   
   <div id="reports" class="hidden section">
     <h3>Report List</h3>
     
     <div style="margin-bottom: 15px;">
        <label style="font-weight:600; color:var(--muted);">Filter by Cashier:</label>
        <select id="reportCashierFilter" style="margin-top:5px;">
            <option value="All">All Cashiers</option>
        </select>
     </div>
     
     <div id="reportList"></div>
   </div>
</div>

<!-- CASHIER PAGE -->
<div id="cashierPage" class="container hidden">
<div id="cashierHeader" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
  <h2 class="cashier-text">Cashier POS</h2>
  <div class="lag" style="display:flex; gap:5px;">
     <button onclick="managePanel()">
     <img class="menuBtn" src="Image/Menu.png" alt="Image/Menu.png">
     </button>
  </div>
</div>
<div id="side-panel" style="display:flex; flex-direction:column; justify-content: space-between;">
   <div>
      <div style="display:flex; justify-content:space-between; align-items:center; padding: 10px 10px;">
         <h1 style="color: #f6f6f6; font-size: 20px">Cashier: <strong id="cashierNameDisplay"></strong></h1>
         <button onclick="managePanel()" style="width:40px; height:40px;">X</button>
      </div>
      <div class="panel-btn" style="margin-top:50px">
       <button onclick="openSalesHistory()">Sales History</button>
        <button id="themeToggle"> ðŸŒ™ Dark Mode</button>
       <button onclick="logout()">Logout</button>
      </div>
   </div>
   <div style="padding:10px; display:flex; justify-content: space-between">
      
   <small>v5.0.2.23 beta</small>
   <small>Dev:jeypsss</small>
   </div>
</div>
<!-- ADD EXPENSE MODAL -->
<div id="expenseModal" class="modal" style="z-index: 9999999">
  <div class="modal-content" style="border: 1px solid whitesmoke">
    <h3>Add Expense</h3>

    <label>Description</label>
    <input type="text" id="expenseDesc" placeholder="e.g. Transportation">

    <label>Amount</label>
    <input type="number" id="expenseAmount" placeholder="e.g. 150">

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button style="flex:1; padding: 10px;" onclick="saveExpense()">Save</button>
      <button style="flex:1; background:#eee; color:#333; padding:10px;" onclick="closeExpenseModal()">Cancel</button>
    </div>
  </div>
</div>

Â  <div id="cashierCategoryButtons"></div>
Â  <div id="pos">
Â  Â  <div id="productGrid"></div>
Â  Â  <div id="cart">
Â  Â  Â  <h3>Cart</h3>
Â  Â  Â  <table id="cartTable">
Â  Â  Â  Â  <tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th>Remove</th></tr>
Â  Â  Â  </table>
Â  Â  Â  <p style="font-weight:700; margin-top:8px;">Total: â‚±<span id="cartTotal">0</span></p>
Â  Â  Â  <button onclick="checkout()" style="height:50px">Checkout</button>
Â  Â  </div>
Â  Â  <div style="margin-top:10px; font-size:12px; color:var(--muted)">
Â  Â     
Â  Â  </div>
Â  </div>
Â  
  <div id="dailySummary" class="section">
     <h3>Daily Sales</h3>
     <div id="dailyCategoryButtons" style="margin-bottom:10px;"></div>
     <div id="dailyTotalBox" style="font-weight:800; margin:20px 0;">Daily Total: â‚±0</div>
     <div id="dailySalesList"></div>
   </div>

</div>

<!-- SALES HISTORY MODAL -->
<div id="salesHistoryModal" class="modal">
  <div class="modal-content" style="max-width:800px; overflow-y:auto; max-height:100%">
    <div style="margin-top:12px; text-align:right;">
      <button onclick="closeSalesHistory()">Close</button>
    </div>
    <h3 style="text-align:center;">Sales History</h3>

    <div id="sales-history-dd" style="display:flex; gap:10px; margin-bottom:10px;">
      <div style="flex:1;" >
        <label>From:</label>
        <select id="historyDateFrom"></select>
      </div>
      <div style="flex:1;">
        <label>To:</label>
        <select id="historyDateTo"></select>
      </div>
    </div>

    <div style="overflow-x:auto;">
      <table id="historyTable" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#dff1ff;">
            <th style="padding:8px;border:1px solid #cfe9ff;">Date</th>
            <th style="padding:8px;border:1px solid #cfe9ff;">Silver</th>
            <th style="padding:8px;border:1px solid #cfe9ff;">Sportswear</th>
            <th style="padding:8px;border:1px solid #cfe9ff;">Indu</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-top:12px;">
  <button id="addExpenseBtn" onclick="openExpenseModal()">+ Add Expense</button>
  <p id="List-txt"></p>
</div>

<div id="expenseList" style="margin-top:10px;"></div>
<div style="display:flex; justify-content:space-between; align-itemscenter;">
   <div id="historyTotals" style="margin-top:12px; font-weight:700; ">
   </div>
   <div style="display:flex; align-items:end">
       <button id="makeReportBtn" style="padding:12px" onclick="openReportPassword()">Make Report</button>
   </div>
</div>
  </div>
</div>
<div id="reportPasswordModal" class="modal" >
  <div class="modal-content" style="border: 1px solid #cccccc">
    <h3>Confirm Report</h3>
    <di id="reportSum">Report Summary: </di>
    <input type="password" id="reportPassword" placeholder="Enter your password" style="margin-top: 20px;">
    <div style="margin-top:10px">
    <button onclick="confirmMakeReport()">Confirm</button>
    <button onclick="closeReportPassword()">Cancel</button>
    </div>
  </div>
</div>

<!-- ACCESS DENIED MODAL (NEW) -->
<div id="accessDeniedModal" class="modal" style="z-index: 100000000;">
  <div class="modal-content" style="text-align:center; border: 2px solid var(--danger);">
    <h3 style="color:var(--danger)">ACCESS DENIED</h3>
    <p style="font-size:18px; margin: 20px 0;">Your account has been disabled by the administrator, ask admin for access</p>
    <button onclick="closeAccessDenied()" style="background: var(--muted);">Close</button>
  </div>
</div>

<!-- MODAL -->
<div id="productModal" class="modal" >
Â  <div class="modal-content">
Â  Â  <h3 id="modalName"></h3>
Â  Â  <div id="customNameDiv" style="display:none; margin-bottom:8px;">
Â  Â  Â  Product Name: <input type="text" id="modalCustomName" placeholder="Enter product name">
Â  Â  </div>
Â  Â  <div style="margin-bottom:8px;">Price: â‚±<input type="number" id="modalPrice" value="0" style="width:110px; display:inline-block; margin-left:6px;"></div>
Â  Â  <div class="qty-buttons" style="margin-bottom:10px;">
Â  Â  Â  <button onclick="decreaseQty()">-</button>
Â  Â  Â  <input type="number" id="modalQty" value="1" style="width:60px; text-align:center;">
Â  Â  Â  <button onclick="increaseQty()">+</button>
Â  Â  </div>
Â  Â  <div style="display:flex; gap:8px;">
Â  Â  Â  <button style="flex:1;" onclick="modalAddToCart()">Add to Cart</button>
Â  Â  Â  <button style="flex:1; background:#f0f0f0; color:var(--muted);" onclick="closeModal()">Cancel</button>
Â  Â  </div>
Â  </div>
</div>

<!-- EDIT PRODUCT MODAL -->
<div id="editProductModal" class="modal">
  <div class="modal-content">
    <h3>Edit Product</h3>

    <input type="hidden" id="editProdId">

    <label>Product Name</label>
    <input type="text" id="editProdName">

    <label>Category</label>
    <select id="editProdCat">
      <option value="Sportswear">Sportswear</option>
      <option value="Silver">Silver</option>
      <option value="Indu">Indu</option>
    </select>

    <label>Price</label>
    <input type="number" id="editProdPrice">

    <label>Stock</label>
    <input type="number" id="editProdStock">

    <div style="display:flex; gap:10px; margin-top:10px;">
      <button style="flex:1;" onclick="saveEditProduct()">Save</button>
      <button style="flex:1; background:#eee; color:#333;" onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- EDIT CASHIER MODAL (NEW) -->
<div id="editCashierModal" class="modal">
  <div class="modal-content">
    <h3>Edit Cashier</h3>

    <input type="hidden" id="editCashierId">

    <label>Username</label>
    <input type="text" id="editCashierName" placeholder="New Username">

    <label>Password</label>
    <input type="password" id="editCashierPass" placeholder="New Password">

    <div style="display:flex; gap:10px; margin-top:10px;">
      <button style="flex:1;" onclick="saveEditCashier()">Save</button>
      <button style="flex:1; background:#eee; color:#333;" onclick="closeEditCashierModal()">Cancel</button>
    </div>
  </div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, deleteDoc,
  doc, updateDoc, setDoc, increment, getDoc,
  query, where, writeBatch, deleteField, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


/* ===== YOUR FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDv0y5aS1ldtZlNfYZ5IsRhGsrSQaX45MA",
  authDomain: "weartrack-c71ab.firebaseapp.com",
  projectId: "weartrack-c71ab",
  storageBucket: "weartrack-c71ab.firebasestorage.app",
  messagingSenderId: "713165835734",
  appId: "1:713165835734:web:a0f2e71bd045ffb4f86877"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ðŸ’¾ CART LOCALSTORAGE HELPERS
function saveCartToStorage() {
  localStorage.setItem('pos_cart', JSON.stringify(cart));
}

function loadCartFromStorage() {
  const saved = localStorage.getItem('pos_cart');
  if (saved) {
    try {
      cart = JSON.parse(saved) || [];
    } catch (e) {
      cart = [];
    }
  }
}



/* ---------- GLOBAL ---------- */

// ===== FIRESTORE CACHES (READ OPTIMIZATION) =====
let productsCache = null;
let salesCache = null;
let expensesCache = null;
let cashiersCache = null;

let currentUser = null;
let isViewingReport = false;
let cart = [];
let modalProductIndex = null;
let isAddingToCart = false;
let isRemovingItem = {};
let currentAdminFilter = 'All';
let currentAdminCashier = 'All';
let currentCashierCategory = 'Sportswear';
let currentDailyCategory = 'All';
const fixedCategories = ['Sportswear','Silver','Indu'];
let customCategoryStatus = {
  Sportswear: true,
  Silver: true,
  Indu: true
};

// ðŸŒŸ GLOBAL LISTENER VARIABLE
let unsubscribeCashierListener = null;

/* ---------- SCALABILITY HELPERS ---------- */

// ONE-TIME MIGRATION: Run this in console: window.migrateCounters()
window.migrateCounters = async function() {
    console.log("Starting Counter Migration (Strict Format)...");
    const sales = await getSalesOnce(true); 

    const counts = {};
    const batch = writeBatch(db);
    
    sales.forEach(s => {
        let dateKey;
        // Even if dateKey exists, we regenerate it to be safe and consistent
        // We use the 'date' string (ISO) and force it to YYYY-MM-DD local logic
        const dateObj = new Date(s.date);
        
        // STRICT FORMATTING: YYYY-MM-DD
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        dateKey = `${year}-${month}-${day}`;

        if (counts[dateKey]) {
            counts[dateKey]++;
        } else {
            counts[dateKey] = 1;
        }
    });

    // 3. Save to Firestore
    await setDoc(doc(db, 'meta_data', 'sales_counter'), counts);
    alert("Migration Finished! Counters updated.");
}

async function fetchSalesByRange(startDate, endDate) {
  // Inputs: "2025-12-27" (YYYY-MM-DD) or Date objects
  
  // Helper: Force string YYYY-MM-DD into Local Midnight Date Object
  const getLocalStart = (val) => {
     if(val instanceof Date) {
        // FIX: Clone the date object to prevent mutation of original reference
        const d = new Date(val); 
        d.setHours(0,0,0,0);
        return d;
     }
     // Manually parse YYYY-MM-DD to avoid UTC shift
     const p = val.split('-');
     return new Date(p[0], p[1]-1, p[2]);
  }

  const start = getLocalStart(startDate);
  
  const end = getLocalStart(endDate);
  end.setHours(23, 59, 59, 999);

  // Firestore Query
  const q = query(
    collection(db, 'sales'),
    where('date', '>=', start.toISOString()),
    where('date', '<=', end.toISOString())
  );

  const snap = await getDocs(q);
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

// ================== HELPER TO FORCE YYYY-MM-DD ==================
function standardizeDate(dateStr) {
  if(!dateStr) return '';
  let d = dateStr.toString().trim(); // Convert to string and trim whitespace

  // Handle slashes MM/DD/YYYY -> YYYY-MM-DD
  if(d.includes('/')) {
     const parts = d.split('/');
     if(parts.length === 3) {
        // parts[0] = M, parts[1] = D, parts[2] = Y
        return `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
     }
  }
  // Handle dashes YYYY-M-D -> YYYY-MM-DD
  if(d.includes('-')) {
     const parts = d.split('-');
     if(parts.length === 3) {
        return `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
     }
  }
  return d;
}


/* ---------- LOGIN ---------- */
async function login() {
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  const msg = document.getElementById('loginMsg');
  if (u === 'Admin' && p === 'admin' || u === 'Paul' && p === 'Paul02073') {
    currentUser = { role: 'admin', name: 'admin' };
localStorage.setItem('loggedInUser', JSON.stringify(currentUser));

    document.getElementById('login').classList.add('hidden');
    document.getElementById('adminPage').classList.remove('hidden');
    showSection('inventory');
    await loadInventory();
    await loadCashiers();
    await loadSales(); // Loads via counter now
    msg.innerText = '';
    return;
  }
  const cashiers = await getCashiersOnce();
  const cashier = cashiers.find(c => c.username === u && c.password === p);

  if (cashier) {
      // âœ… CHECK IF DISABLED
      if(cashier.disabled === true) {
          document.getElementById('accessDeniedModal').style.display = 'flex';
          return;
      }

  // âœ… FIX: Use the exact username from the database (e.g. "Diana"), not what user typed ("diana")
  // This ensures document IDs in 'reported_dates' match correctly.
  currentUser = { role: 'cashier', name: cashier.username };
  
  localStorage.setItem('loggedInUser', JSON.stringify(currentUser));

  document.getElementById('login').classList.add('hidden');
  document.getElementById('cashierPage').classList.remove('hidden');
  document.getElementById('cashierNameDisplay').innerText = currentUser.name;

  await loadSettings();
  await loadProducts();
  await loadDailySales();
  
  // ðŸŒŸ START LISTENING FOR LOCKOUTS
  monitorCashierStatus();

  msg.innerText = '';
  return;
}else{
   alert("WRONG PASSWORD OR USERNAME!");
}
}

function closeAccessDenied() {
    document.getElementById('accessDeniedModal').style.display = 'none';
}

window.managePanel = function () {
  document.getElementById("side-panel").classList.toggle("active");
};

window.adminPanel = function () {
  document.getElementById("adminPanel").classList.toggle("active");
};

// ðŸŒŸ NEW FUNCTION: REAL-TIME SECURITY CHECK
function monitorCashierStatus() {
   // Only run if it's a cashier
   if(!currentUser || currentUser.role !== 'cashier') return;

   // Query for the current user's document
   const q = query(collection(db, 'cashiers'), where('username', '==', currentUser.name));
   
   // Start Listener
   unsubscribeCashierListener = onSnapshot(q, (snapshot) => {
       if(!snapshot.empty) {
           const data = snapshot.docs[0].data();
           
           // If they get disabled while using the app:
           if(data.disabled === true) {
               // Show modal
               document.getElementById('accessDeniedModal').style.display = 'flex';
               
               // Logout after 2 seconds
               setTimeout(() => {
                   document.getElementById('accessDeniedModal').style.display = 'none';
                   logout();
               }, 2000);
           }
       }
   }, (error) => {
       console.log("Listener error (ignore if logged out):", error);
   });
}


function logout() {
  // ðŸŒŸ STOP LISTENER TO SAVE RESOURCES
  if(unsubscribeCashierListener) {
      unsubscribeCashierListener();
      unsubscribeCashierListener = null;
  }
  cashiersCache = null
  currentUser = null;
  cart = [];
  localStorage.removeItem('pos_cart');
  localStorage.removeItem('loggedInUser');
  document.getElementById('login').classList.remove('hidden');
  document.getElementById('adminPage').classList.add('hidden');
  document.getElementById('cashierPage').classList.add('hidden');
  document.getElementById('side-panel').classList.remove('active');
}


/* ---------- ADMIN ---------- */
function showSection(id) {
  ['inventory', 'cashiers', 'salesSummary', 'settings', 'reports']
    .forEach(sec => document.getElementById(sec).classList.add('hidden'));

  document.getElementById(id).classList.remove('hidden');

  if (id === 'settings') loadSettings();
  if (id === 'reports') loadReports(); // âœ… ADD THIS
  document.getElementById("adminPanel").classList.remove("active");
}




function toggleAddProduct() {
  document.getElementById('addProductForm').classList.toggle('hidden');
}

async function loadSettings() {
  const settingsSnap = await getDocs(collection(db, 'settings'));

  const existing = {};
  settingsSnap.docs.forEach(docu => {
    existing[docu.id] = docu.data().enabled;
  });

  // Defaults if not yet saved
  fixedCategories.forEach(cat => {
    customCategoryStatus[cat] =
      existing[cat] !== undefined ? existing[cat] : true;
  });

  const list = document.getElementById('settingsList');
  list.innerHTML = '';

  fixedCategories.forEach(cat => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.background = 'var(--card)';
    row.style.padding = '12px';
    row.style.borderRadius = '10px';
    row.style.boxShadow = '0 2px 5px rgba(0,0,0,0.06)';

    const label = document.createElement('strong');
    label.innerText = `${cat} Custom Transaction`;

    const toggle = document.createElement('button');
    toggle.innerText = customCategoryStatus[cat] ? 'Enabled' : 'Disabled';
    toggle.style.background = customCategoryStatus[cat]
      ? 'var(--primary)'
      : 'var(--danger)';

    toggle.onclick = async () => {
  customCategoryStatus[cat] = !customCategoryStatus[cat];

  const docRef = doc(db, 'settings', cat);

  // âœ… Always save using the category name as the document ID
  await setDoc(docRef, {
    enabled: customCategoryStatus[cat]
  }, { merge: true });

  await loadSettings();
  await loadProducts();
};


    row.appendChild(label);
    row.appendChild(toggle);
    list.appendChild(row);
  });
}


/* ---------- INVENTORY (COMPLETELY REDESIGNED) ---------- */
async function loadInventory() {
  const products = await getProductsOnce();
  const list = document.getElementById('inventoryList'); 
  list.innerHTML = '';

  products.forEach((p) => {
    // 1. Badge Class based on Category
    let badgeClass = 'badge-silver';
    if(p.category === 'Sportswear') badgeClass = 'badge-sport';
    else if(p.category === 'Indu') badgeClass = 'badge-indu';

    // 2. Stock Logic (Colors & Text)
    // Assuming max of 50 for visual bar if not specified, 
    // or just calculate relative fullness for effect.
    // Logic: Green > 20, Yellow < 10, Red = 0.
    
    let stockColorClass = 'stock-green';
    let barColorClass = 'bar-green';
    let stockLabel = 'Available';
    let stockCountText = `${p.stock} Stock`;
    let fillPercent = Math.min((p.stock / 50) * 100, 100); // Visual cap at 50

    if(p.stock <= 0) {
        stockColorClass = 'stock-red';
        barColorClass = 'bar-red';
        stockLabel = 'Unavailable';
        stockCountText = '0 Stock';
        fillPercent = 0;
    } else if (p.stock < 10) {
        stockColorClass = 'stock-yellow';
        barColorClass = 'bar-yellow';
        stockLabel = 'Low Stock';
        stockCountText = `${p.stock} Left`;
    }

    const card = document.createElement('div');
    card.className = 'inventory-card';
    
    card.innerHTML = `
        <div class="inv-top">
            <span class="inv-badge ${badgeClass}">${p.category}</span>
            <span class="inv-price">â‚±${p.price}</span>
        </div>
        
        <div class="inv-name">${p.name}</div>
        
        <div class="inv-stock-container">
            <div class="inv-stock-labels">
                <span class="stock-label-text">${stockLabel}</span>
                <span class="stock-val-text ${stockColorClass}">${stockCountText}</span>
            </div>
            <div class="stock-bar-bg">
                <div class="stock-bar-fill ${barColorClass}" style="width: ${fillPercent}%"></div>
            </div>
        </div>

        <div class="inv-actions">
            <button class="inv-btn inv-btn-edit" data-id="${p.id}">Edit</button>
            <button class="inv-btn inv-btn-del" data-id="${p.id}">Delete</button>
        </div>
    `;

    list.appendChild(card);
  });

  // Re-attach event listeners
  document.querySelectorAll('.inv-btn-del').forEach(btn => {
    btn.addEventListener('click', function () {
      deleteProduct(this.dataset.id);
    });
  });
  document.querySelectorAll('.inv-btn-edit').forEach(btn => {
    btn.addEventListener('click', function () {
      editProduct(this.dataset.id);
    });
  });
}

function closeEditModal() {
  document.getElementById('editProductModal').style.display = 'none';
}

async function saveEditProduct() {
  const id = document.getElementById('editProdId').value;
  const name = document.getElementById('editProdName').value.trim();
  const category = document.getElementById('editProdCat').value;
  const price = parseFloat(document.getElementById('editProdPrice').value);
  const stock = parseInt(document.getElementById('editProdStock').value);

  if (!name || !category || isNaN(price) || isNaN(stock)) {
    return alert('Please fill all fields!');
  }

  await updateDoc(doc(db, 'products', id), {
    name,
    category,
    price,
    stock
  });
  productsCache = null;

  closeEditModal();
  await loadInventory();

  if (!document.getElementById('cashierPage').classList.contains('hidden')) {
    await loadProducts();
  }
}


async function addProduct() {
  const n = document.getElementById('prodName').value.trim();
  const c = document.getElementById('prodCat').value;
  const price = parseFloat(document.getElementById('prodPrice').value);
  const stock = parseInt(document.getElementById('prodStock').value);
  if (!n || !c || !price || !stock) return alert('Please fill all required fields!');
  await addDoc(collection(db, 'products'), { name: n, category: c, price, stock });
  productsCache = null;
  await loadInventory();
  if (!document.getElementById('cashierPage').classList.contains('hidden')) await loadProducts();
  document.getElementById('prodName').value = '';
  document.getElementById('prodCat').value = '';
  document.getElementById('prodPrice').value = '';
  document.getElementById('prodStock').value = '';
}

async function deleteProduct(id) {
  if (confirm('Delete this product?')) {
    await deleteDoc(doc(db, 'products', id));
    productsCache = null;
    await loadInventory();
    if (!document.getElementById('cashierPage').classList.contains('hidden')) await loadProducts();
  }
}
async function editProduct(id) {
  const products = await getProductsOnce();
const product = products.find(p => p.id === id);
if (!product) return;

const data = product;

  document.getElementById('editProdId').value = id;
  document.getElementById('editProdName').value = data.name;
  document.getElementById('editProdCat').value = data.category;
  document.getElementById('editProdPrice').value = data.price;
  document.getElementById('editProdStock').value = data.stock;

  document.getElementById('editProductModal').style.display = 'flex';
}



/* ---------- CASHIERS (UPDATED FOR NEW DESIGN) ---------- */
async function loadCashiers() {
  const cashiersSnapshot = await getDocs(collection(db, 'cashiers'));
  const cashiers = cashiersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  
  const list = document.getElementById('cashierList'); 
  list.innerHTML = ''; // Clear previous

  cashiers.forEach((c) => {
    // Check disable status
    const isDisabled = c.disabled === true;
    
    // Determine visual states
    const statusBadge = isDisabled 
        ? '<span class="status-badge status-disabled">Disabled</span>' 
        : '<span class="status-badge status-active">Active</span>';

    const cardClass = isDisabled ? 'cashier-card is-disabled' : 'cashier-card';
    const avatarInitial = c.username.charAt(0).toUpperCase();
    
    // Toggle Button Logic
    const toggleBtnClass = isDisabled ? 'btn-toggle enable-state' : 'btn-toggle';
    const toggleBtnText = isDisabled ? 'Enable' : 'Disable';

    const html = `
    <div class="${cardClass}">
        <div class="card-header">
            <div class="avatar">${avatarInitial}</div>
            <div class="info">
                <span class="username">${c.username}</span>
                ${statusBadge}
            </div>
        </div>
        <div class="card-actions">
            <button class="action-btn ${toggleBtnClass}" onclick="toggleCashierStatus('${c.id}', ${isDisabled})">${toggleBtnText}</button>
            <button class="action-btn btn-edit" onclick="openEditCashierModal('${c.id}')">Edit</button>
            <button class="action-btn btn-delete" onclick="deleteCashier('${c.id}')">Ã—</button>
        </div>
    </div>`;
    
    list.innerHTML += html;
  });
}

// NEW FUNCTION: Toggle Disable/Enable
async function toggleCashierStatus(id, currentStatus) {
    // Flip the status
    const newStatus = !currentStatus;
    
    await updateDoc(doc(db, 'cashiers', id), {
        disabled: newStatus
    });
    
    cashiersCache = null; // refresh cache
    await loadCashiers();
}

async function addCashier() {
  const u = document.getElementById('cashierName').value.trim();
  const p = document.getElementById('cashierPass').value.trim();
  if (!u || !p) return alert('Fill all fields');
  await addDoc(collection(db, 'cashiers'), { username: u, password: p, disabled: false });
  await loadCashiers();
  document.getElementById('cashierName').value = '';
  document.getElementById('cashierPass').value = '';
  cashiersCache = null;
}

async function deleteCashier(id) {
  if (confirm('Delete this cashier?')) {
    await deleteDoc(doc(db, 'cashiers', id));
    await loadCashiers();
  }
}

// ===== NEW EDIT CASHIER MODAL LOGIC =====
async function openEditCashierModal(id) {
  const cashiers = await getCashiersOnce();
  const cashier = cashiers.find(c => c.id === id);
  if(!cashier) return;

  document.getElementById('editCashierId').value = id;
  document.getElementById('editCashierName').value = cashier.username;
  document.getElementById('editCashierPass').value = cashier.password;

  document.getElementById('editCashierModal').style.display = 'flex';
}

function closeEditCashierModal() {
  document.getElementById('editCashierModal').style.display = 'none';
}

async function saveEditCashier() {
  const id = document.getElementById('editCashierId').value;
  const newName = document.getElementById('editCashierName').value.trim();
  const newPass = document.getElementById('editCashierPass').value.trim();

  if(!newName || !newPass) {
    return alert("Please fill all fields");
  }

  await updateDoc(doc(db, 'cashiers', id), { username: newName, password: newPass });
  
  cashiersCache = null; // Clear cache to ensure refresh
  await loadCashiers();
  closeEditCashierModal();
}
// =========================================

/* ---------- ADMIN SALES (UPDATED FOR REDESIGN) ---------- */
async function loadSales() {
  // 1. Get the Counters
  const counterSnap = await getDoc(doc(db, 'meta_data', 'sales_counter'));
  
  let availableDates = [];
  if (counterSnap.exists()) {
    const data = counterSnap.data();
    availableDates = Object.keys(data).filter(dateKey => data[dateKey] > 0);
    availableDates.sort(); 
  }

  const fromSel = document.getElementById('adminDateFrom');
  const toSel = document.getElementById('adminDateTo');
  
  fromSel.innerHTML = "";
  toSel.innerHTML = "";

  availableDates.forEach(d => {
      const opt1 = document.createElement('option');
      opt1.value = d;
      opt1.innerText = d; 
      fromSel.appendChild(opt1);

      const opt2 = opt1.cloneNode(true);
      toSel.appendChild(opt2);
  });

  if(availableDates.length > 0) {
      fromSel.value = availableDates[availableDates.length - 1];
      toSel.value = availableDates[availableDates.length - 1];
  }

  const catBtns = document.getElementById('adminCategoryButtons');
  catBtns.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.innerText = 'All';
  allBtn.onclick = () => filterSales('All');
  catBtns.appendChild(allBtn);

  fixedCategories.forEach(cat => {
    const btn = document.createElement('button');
    btn.innerText = cat;
    btn.onclick = () => filterSales(cat);
    catBtns.appendChild(btn);
  });

  const cashierSelect = document.getElementById('adminCashierFilter');
  cashierSelect.innerHTML = '<option value="All">All Cashiers</option>';
  const cashiers = await getCashiersOnce();
  cashiers.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.username;
    opt.innerText = c.username;
    cashierSelect.appendChild(opt);
  });
  
  currentAdminCashier = 'All';
  cashierSelect.onchange = () => {
    currentAdminCashier = cashierSelect.value;
    filterSales(currentAdminFilter);
  };

  fromSel.onchange = () => filterSales(currentAdminFilter);
  toSel.onchange   = () => filterSales(currentAdminFilter);
  
  await filterSales('All');
}


async function filterSales(cat) {
  currentAdminFilter = cat;
  
  document.querySelectorAll('#adminCategoryButtons button').forEach(btn => {
    btn.classList.toggle('active-cat', btn.innerText === cat);
  });

  const fromStr = document.getElementById('adminDateFrom').value;
  const toStr   = document.getElementById('adminDateTo').value;

  if(!fromStr || !toStr) {
      document.getElementById('salesList').innerHTML = 'No dates with sales found.';
      document.getElementById('adminGrandTotal').innerText = `Total: â‚±0`;
      return;
  }

  let sales = await fetchSalesByRange(fromStr, toStr);
  sales.sort((a, b) => new Date(b.date) - new Date(a.date));

  const list = document.getElementById('salesList'); list.innerHTML = '';
  let grandTotal = 0;

  for (const s of sales) {
     if (currentAdminCashier !== 'All' && s.cashier !== currentAdminCashier) {
       continue;
     }

    let filtered = s.products;
    if (cat !== 'All') {
      filtered = s.products.filter(p => p.category === cat);
    }

    if (filtered.length === 0) continue;

    // ================== NEW CARD RENDER (Admin) ==================
    const ticket = document.createElement('div');
    ticket.className = 'sale-ticket';

    // Header
    const header = document.createElement('div');
    header.className = 'ticket-header';
    header.innerHTML = `
        <div class="ticket-meta">
            <span class="meta-time">${new Date(s.date).toLocaleString()}</span>
            <span class="meta-cashier">Cashier: ${s.cashier}</span>
        </div>
    `;

    const delBtn = document.createElement('button');
    delBtn.className = 'btn-delete-ticket';
    delBtn.innerText = 'Ã—'; // Special X character
    
    delBtn.onclick = async () => {
      if (!confirm('Delete this transaction?')) return;

      const products = await getProductsOnce();
      for (const p of s.products) {
        // âœ… BUG FIX: Only return stock if the sold item has a valid Product ID
        if (p.productId) {
            await updateDoc(doc(db, 'products', p.productId), {
              stock: increment(p.qty)
            });
            productsCache = null;
        } else if (p.productId === null) {
            // New custom item -> do nothing
        } else {
             // Legacy fallback (optional): checks name for old transactions
             const prod = products.find(pr =>
                pr.name === p.name && pr.category === p.category
             );
             if (prod) {
               await updateDoc(doc(db, 'products', prod.id), {
                  stock: increment(p.qty)
               });
               productsCache = null;
             }
        }
      }

      let dateKey;
      if(s.dateKey) {
        dateKey = s.dateKey;
      } else {
        const dateObj = new Date(s.date);
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        dateKey = `${year}-${month}-${day}`;
      }
      
      // âœ… 1. UPDATE SUMMARY (Subtract)
      const summaryId = `${dateKey}_${s.cashier}`;
      const summaryRef = doc(db, 'daily_summaries', summaryId);
      
      const summaryUpdates = { GrandTotal: increment(-s.total) };
      
      // âœ… FIX: Calculate category totals first, then subtract (handles multiple items of same cat)
      const catTotals = {};
      s.products.forEach(p => {
          if (!catTotals[p.category]) catTotals[p.category] = 0;
          catTotals[p.category] += (p.qty * p.price);
      });

      for(const [cat, amt] of Object.entries(catTotals)){
         summaryUpdates[cat] = increment(-amt);
      }

      await setDoc(summaryRef, summaryUpdates, { merge: true });


      await updateDoc(doc(db, 'meta_data', 'sales_counter'), {
          [dateKey]: increment(-1)
      });

      await deleteDoc(doc(db, 'sales', s.id));
      salesCache = null; 
      
      const counterSnap = await getDoc(doc(db, 'meta_data', 'sales_counter'));
      if(counterSnap.exists() && counterSnap.data()[dateKey] <= 0) {
         await loadSales(); 
      } else {
         await filterSales(currentAdminFilter);
      }
    };

    header.appendChild(delBtn);
    ticket.appendChild(header);

    // Body
    const body = document.createElement('div');
    body.className = 'ticket-body';

    let saleTotal = 0;
    filtered.forEach(p => {
      // Map badge class
      let badgeClass = 'other';
      if(p.category === 'Sportswear') badgeClass = 'sport';
      if(p.category === 'Silver') badgeClass = 'silver';
      if(p.category === 'Indu') badgeClass = 'indu';

      const itemRow = document.createElement('div');
      itemRow.className = 'ticket-item';
      itemRow.innerHTML = `
        <div class="item-info">
            <span class="badge ${badgeClass}">${p.category}</span>
            <span>${p.name}</span>
            <span class="item-qty">x${p.qty}</span>
        </div>
        <span>â‚±${p.qty * p.price}</span>
      `;
      body.appendChild(itemRow);
      saleTotal += (p.qty * p.price);
    });
    ticket.appendChild(body);

    // Footer
    const footer = document.createElement('div');
    footer.className = 'ticket-footer';
    footer.innerHTML = `
        <span class="total-label">TOTAL AMOUNT</span>
        <span class="total-price">â‚±${saleTotal}</span>
    `;
    ticket.appendChild(footer);

    grandTotal += saleTotal;
    list.appendChild(ticket);
    // =============================================================
  }
  
   document.getElementById('adminGrandTotal').innerText = `Total: â‚±${grandTotal}`;

}

/* ---------- CASHIER ---------- */
async function loadProducts() {
  await populateCategoryButtons();  // draw buttons first
  await filterCashierProducts(currentCashierCategory);  // keep current category
}


function populateCategoryButtons() {
  const container = document.getElementById('cashierCategoryButtons');
  container.innerHTML = '';

  fixedCategories.forEach(cat => {
    const btn = document.createElement('button');
    btn.innerText = cat;
    btn.className = 'cat-btn';

    if (cat === currentCashierCategory) {
      btn.classList.add('active-cat');
    }

    btn.onclick = async () => {
      currentCashierCategory = cat;
      await filterCashierProducts(cat);
      highlightActiveCategory();
    };

    container.appendChild(btn);
  });
}
function highlightActiveCategory() {
  const buttons = document.querySelectorAll('#cashierCategoryButtons button');
  buttons.forEach(btn => {
    if (btn.innerText === currentCashierCategory) {
      btn.classList.add('active-cat');
    } else {
      btn.classList.remove('active-cat');
    }
  });
}


async function filterCashierProducts(category) {
  let products = await getProductsOnce();
  if (category) products = products.filter(p => p.category === category);
  displayCashierProducts(products);
}


function displayCashierProducts(products) {
  const grid = document.getElementById('productGrid');
  grid.innerHTML = '';

  products.forEach((p) => {
    // 1. Get Initials
    const initials = p.category ? p.category.substring(0, 2) : '??';

    // 2. Determine Stock Class
    let stockClass = 'stock-high';
    let stockText = `${p.stock} Left`;
    if (p.stock <= 0) {
        stockClass = 'stock-out';
        stockText = 'Out';
    } else if (p.stock < 10) {
        stockClass = 'stock-low';
    }

    grid.innerHTML += `
    <div class="product" onclick="openModal('${p.id}')">
        <div class="product-top">
            <div class="category-avatar">${initials}</div>
            <div class="stock-pill ${stockClass}">${stockText}</div>
        </div>
        <div class="product-name">${p.name}</div>
        <div class="product-price">â‚±${p.price}</div>
    </div>`;
  });

  // Custom Transaction Card
  if (customCategoryStatus[currentCashierCategory] !== false) {
    grid.innerHTML += `
      <div class="product custom-product" onclick="openCustomModal()">
        <div class="custom-content">
            <div class="custom-icon">+</div>
            <div style="font-weight:600; font-size:14px;">Custom Amount</div>
        </div>
      </div>
    `;
  }
}

/* ---------- MODAL ---------- */
async function openModal(id) {
  modalProductIndex = id;
  document.getElementById('customNameDiv').style.display = 'none';
  
  const products = await getProductsOnce();
  const product = products.find(p => p.id === id);
  if (!product) return;
  
  if (product.stock <= 0) {
    alert('Out of stock!');
    return;
  }
  document.getElementById('modalName').innerText = product.name;
  document.getElementById('modalPrice').value = product.price;
  document.getElementById('modalQty').value = 1;

  document.getElementById('productModal').style.display = 'flex';
}


function openCustomModal() {
   
  modalProductIndex = null;
  document.getElementById('customNameDiv').style.display = 'block';
  document.getElementById('modalName').innerText = 'Custom Transaction';
  document.getElementById('modalPrice').value = 0;
  document.getElementById('modalQty').value = 1;
  document.getElementById('modalCustomName').value = '';
  document.getElementById('productModal').style.display = 'flex';
}

function closeModal() { document.getElementById('productModal').style.display = 'none'; }
function decreaseQty() { const el = document.getElementById('modalQty'); if (parseInt(el.value) > 1) el.value = parseInt(el.value) - 1; }
function increaseQty() { const el = document.getElementById('modalQty'); el.value = parseInt(el.value) + 1; }

async function modalAddToCart() {
  if (isAddingToCart) return;   // ðŸš« block spam clicks
  isAddingToCart = true;

  const addBtn = document.querySelector('#productModal button');
  addBtn.disabled = true;
  
  try {
    let qtyInput = document.getElementById('modalQty').value.trim();
    let qty = parseInt(qtyInput);
   
    // âœ… Fix NaN / empty / invalid quantity
    if (isNaN(qty) || qty <= 0) {
      qty = 1;
      document.getElementById('modalQty').value = 1;
    }
    const price = parseFloat(document.getElementById('modalPrice').value) || 0;
    
    let name, category;
    let productId = null; // âœ… 1. Track Product ID

    if (modalProductIndex === null) {
      // CUSTOM ITEM
      name = document.getElementById('modalCustomName').value.trim() || 'Custom';
      category = currentCashierCategory;
    } else {
      // REAL INVENTORY ITEM
      productId = modalProductIndex; // Capture ID
      
      const productRef = doc(db, 'products', modalProductIndex);
      const products = await getProductsOnce();
      const product = products.find(p => p.id === modalProductIndex);

      if (product.stock < qty) {
        alert('Not enough stock!');
        return;
      }

      await updateDoc(productRef, {
        stock: product.stock - qty
      });
      productsCache = null;
      name = product.name;
      category = product.category;
    }

    // âœ… 2. Add productId to Cart Object
    cart.push({ name, price, qty, category, productId });
    
    renderCart();
    saveCartToStorage();
    // reset modal
    document.getElementById('modalQty').value = 1;
    document.getElementById('modalPrice').value = 0;
    document.getElementById('modalCustomName').value = '';
    closeModal();

    if (!document.getElementById('cashierPage').classList.contains('hidden')) {
      await filterCashierProducts(currentCashierCategory);
      highlightActiveCategory();
    }

  } finally {
    isAddingToCart = false;
    addBtn.disabled = false;
  }
}


/* ---------- CART ---------- */
function renderCart() {
  const table = document.getElementById('cartTable');
  table.innerHTML = '<tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th>Remove</th></tr>';
  let total = 0;
  cart.forEach((p, i) => {
    const tr = document.createElement('tr');
    const subtotal = p.qty * p.price;
    total += subtotal;
    tr.innerHTML = `<td>${p.name}</td><td>${p.qty}</td><td>${p.price}</td><td>${subtotal}</td><td><button onclick="removeCartItem(${i})">X</button></td>`;
    table.appendChild(tr);
  });
  document.getElementById('cartTotal').innerText = total;
  saveCartToStorage();
}

async function removeCartItem(i) {
  // ðŸš« Block spam clicking
  if (isRemovingItem[i]) return;
  isRemovingItem[i] = true;

  try {
    const item = cart[i];
    if (!item) return;

    // âœ… 3. CHECK PRODUCT ID INSTEAD OF NAME (CART REMOVAL FIX)
    // Only return stock if the item has a valid Product ID
    if (item.productId) {
      await updateDoc(doc(db, 'products', item.productId), {
        stock: increment(item.qty) // Atomic increment is safer
      });
      productsCache = null; // Refresh cache
    }

    cart.splice(i, 1);
    renderCart();
    saveCartToStorage();
    await loadProducts();

  } finally {
    delete isRemovingItem[i];
  }
}


async function checkout() {
  if (cart.length === 0) return alert('Cart empty');

  // Loophole Check: Negative Stock Race Condition
  const products = await getProductsOnce(true); 
  for (const item of cart) {
     if(!item.productId) continue; // Skip check for custom items
     const prod = products.find(p => p.id === item.productId);
     if(prod && prod.stock < 0) { 
        return alert(`Error: ${item.name} is out of stock! Transaction cancelled.`);
     }
  }

  const now = new Date();

  // âœ… 4. MERGE ITEMS SAFELY (INCLUDE ID IN KEY)
   const merged = {};
   
   for (const item of cart) {
     const pid = item.productId || 'custom'; // Use 'custom' if null
     // Unique Key: ID + Name + Price
     const key = `${pid}_${item.name}_${item.price}`;
   
     if (!merged[key]) {
       merged[key] = { ...item };
     } else {
       merged[key].qty += item.qty;
     }
   }
   
   const productsCopy = Object.values(merged);


  let saleTotal = 0;
  productsCopy.forEach(p => {
    saleTotal += (p.qty * p.price);
  });

  const startOfDay = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate()
  );

  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const dateKey = `${year}-${month}-${day}`;

  const batch = writeBatch(db);

  const saleRef = doc(collection(db, 'sales'));
  const saleData = {
    cashier: currentUser.name,
    date: now.toISOString(),      
    saleDate: startOfDay.toISOString(),
    dateKey: dateKey, 
    products: productsCopy,
    total: saleTotal
  };

  batch.set(saleRef, saleData);

  const counterRef = doc(db, 'meta_data', 'sales_counter');
  batch.set(counterRef, { [dateKey]: increment(1) }, { merge: true });

  // âœ… 5. UPDATE DAILY SUMMARY (Increment)
  const summaryId = `${dateKey}_${currentUser.name}`;
  const summaryRef = doc(db, 'daily_summaries', summaryId);
  
  const summaryUpdates = {
      date: dateKey,
      cashier: currentUser.name,
      GrandTotal: increment(saleTotal)
  };
  
  // âœ… FIX: Aggregate categories locally first, THEN create increment updates
  // This prevents overwriting increments if multiple items share the same category
  const catTotals = {};
  productsCopy.forEach(p => {
      if (!catTotals[p.category]) catTotals[p.category] = 0;
      catTotals[p.category] += (p.qty * p.price);
  });

  // Apply the increments
  for (const [cat, amount] of Object.entries(catTotals)) {
      summaryUpdates[cat] = increment(amount);
  }
  
  batch.set(summaryRef, summaryUpdates, { merge: true });

  await batch.commit();

  salesCache = null;
  cart = [];
  renderCart();
  localStorage.removeItem('pos_cart');
  await loadDailySales();
  
  alert('Transaction saved!');
}


/* ---------- DAILY SALES (UPDATED FOR REDESIGN) ---------- */
async function loadDailySales() {
  const today = new Date();
  
  let sales = await fetchSalesByRange(today, today);
  sales.sort((a, b) => new Date(b.date) - new Date(a.date));

  const list = document.getElementById('dailySalesList'); list.innerHTML = '';
  document.getElementById('dailyTotalBox').innerText = 'Daily Total: â‚±0';
  
  const daily = sales.filter(s => s.cashier === currentUser.name);

  let dailyTotal = 0;
  for (const s of daily) {
    // Check if this transaction has items of the current category
    let transactionMatchesFilter = false;
    let saleTotal = 0;

    s.products.forEach(p => {
        if(currentDailyCategory === 'All' || p.category === currentDailyCategory) {
            transactionMatchesFilter = true;
            saleTotal += (p.qty * p.price);
        }
    });

    if(!transactionMatchesFilter && currentDailyCategory !== 'All') continue;

    // ================== NEW CARD RENDER (Cashier) ==================
    const ticket = document.createElement('div');
    ticket.className = 'sale-ticket';

    // Header
    const header = document.createElement('div');
    header.className = 'ticket-header';
    header.innerHTML = `
        <div class="ticket-meta">
            <span class="meta-time">${new Date(s.date).toLocaleString()}</span>
            <span class="meta-cashier">Cashier: ${s.cashier}</span>
        </div>
    `;

    const delBtn = document.createElement('button');
    delBtn.className = 'btn-delete-ticket';
    delBtn.innerText = 'Ã—'; 
    delBtn.onclick = async () => {
      if (confirm('Delete this transaction?')) {
        const products = await getProductsOnce();
        for (const pItem of s.products) {
          // âœ… BUG FIX: Only return stock if the sold item has a valid Product ID
          if (pItem.productId) {
               await updateDoc(doc(db, 'products', pItem.productId), {
                 stock: increment(pItem.qty)
               });
               productsCache = null;
          } else if (pItem.productId === null) {
               // New Custom item -> do nothing
          } else {
               // Legacy fallback for old transactions
               const prod = products.find(pr => pr.name === pItem.name && pr.category === pItem.category);
               if (prod) {
                 await updateDoc(doc(db, 'products', prod.id), {
                   stock: increment(pItem.qty)
                 });
                 productsCache = null;
               }
          }
        }

        let dateKey;
        if(s.dateKey) {
            dateKey = s.dateKey;
        } else {
            const dateObj = new Date(s.date);
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            dateKey = `${year}-${month}-${day}`;
        }
        
        // âœ… 6. UPDATE SUMMARY (Subtract on Delete)
        const summaryId = `${dateKey}_${s.cashier}`;
        const summaryRef = doc(db, 'daily_summaries', summaryId);
      
        const summaryUpdates = { GrandTotal: increment(-s.total) };
        
        // âœ… FIX: Calculate category totals first, then subtract (handles multiple items of same cat)
        const catTotals = {};
        s.products.forEach(p => {
            if (!catTotals[p.category]) catTotals[p.category] = 0;
            catTotals[p.category] += (p.qty * p.price);
        });

        for(const [cat, amt] of Object.entries(catTotals)){
            summaryUpdates[cat] = increment(-amt);
        }

        await setDoc(summaryRef, summaryUpdates, { merge: true });


        await updateDoc(doc(db, 'meta_data', 'sales_counter'), {
            [dateKey]: increment(-1)
        });

        await deleteDoc(doc(db, 'sales', s.id));
        salesCache = null;
        await loadDailySales();
        await loadProducts();
      }
    };

    header.appendChild(delBtn);
    ticket.appendChild(header);

    // Body
    const body = document.createElement('div');
    body.className = 'ticket-body';

    // Re-loop to draw items
    s.products
      .filter(p => currentDailyCategory === 'All' || p.category === currentDailyCategory)
      .forEach(p => {
        let badgeClass = 'other';
        if(p.category === 'Sportswear') badgeClass = 'sport';
        if(p.category === 'Silver') badgeClass = 'silver';
        if(p.category === 'Indu') badgeClass = 'indu';

        const itemRow = document.createElement('div');
        itemRow.className = 'ticket-item';
        itemRow.innerHTML = `
            <div class="item-info">
                <span class="badge ${badgeClass}">${p.category}</span>
                <span>${p.name}</span>
                <span class="item-qty">x${p.qty}</span>
            </div>
            <span>â‚±${p.qty * p.price}</span>
        `;
        body.appendChild(itemRow);
      });

    ticket.appendChild(body);

    // Footer
    const footer = document.createElement('div');
    footer.className = 'ticket-footer';
    footer.innerHTML = `
        <span class="total-label">TOTAL AMOUNT</span>
        <span class="total-price">â‚±${saleTotal}</span>
    `;
    ticket.appendChild(footer);

    dailyTotal += saleTotal;
    list.appendChild(ticket);
    // =============================================================
  }
  
  document.getElementById('dailyTotalBox').innerText = `Daily Total: â‚±${dailyTotal}`;
   buildDailyCategoryButtons();
}

function buildDailyCategoryButtons() {
  const container = document.getElementById('dailyCategoryButtons');
  container.innerHTML = '';

  const categories = ['All', 'Sportswear', 'Silver', 'Indu'];

  categories.forEach(cat => {
    const btn = document.createElement('button');
    btn.innerText = cat;

    if (cat === currentDailyCategory) {
      btn.classList.add('active-cat');
    }

    btn.onclick = async () => {
      currentDailyCategory = cat;
      await loadDailySales();
      buildDailyCategoryButtons();
    };

    container.appendChild(btn);
  });
}


async function openSalesHistory() {
   // ðŸ”„ RESET DATE DROPDOWNS
document.getElementById('historyDateFrom').removeAttribute('data-filled');
document.getElementById('historyDateFrom').innerHTML = '';
document.getElementById('historyDateTo').innerHTML = '';

  isViewingReport = false;
document.getElementById('sales-history-dd').style.display = 'flex';
  document.getElementById('historyDateFrom').disabled = false;
  document.getElementById('historyDateTo').disabled = false;
  document.getElementById('addExpenseBtn').style.display = 'inline-block';
  document.getElementById('makeReportBtn').style.display = 'inline-block';

  document.getElementById('salesHistoryModal').style.display = 'flex';
  await buildSalesHistory();
}


function closeSalesHistory() {
  isViewingReport = false;
  document.getElementById('salesHistoryModal').style.display = 'none';
  document.getElementById("List-txt").innerText = "";
}


async function buildSalesHistory() {
    // 1. Fetch ALL summaries for this cashier first (Needed for Date Calculation AND Table)
    const summaryQuery = query(
        collection(db, 'daily_summaries'),
        where('cashier', '==', currentUser.name)
    );
    
    const snaps = await getDocs(summaryQuery);
    let summaryDocs = snaps.docs.map(d => d.data());

    // 2. Extract Available Dates strictly from THIS Cashier's summaries
    // This fixes the issue where global sales dates (from other cashiers) show up here.
    let availableDates = summaryDocs.map(s => s.date).sort();

    // 3. Get reported dates for cashier (to filter out)
    const repDocSnap = await getDocs(collection(db, 'reported_dates'));
    
    // âœ… ROBUST: Find the report document safely by ignoring case sensitivity
    let repDoc = repDocSnap.docs.find(d => d.id === currentUser.name);
    if (!repDoc) {
        repDoc = repDocSnap.docs.find(d => d.id.toLowerCase() === currentUser.name.toLowerCase());
    }

    // âœ… ROBUST: Handle ANY date format using the helper function
    let reportedDates = [];
    if(repDoc && repDoc.data().dates) {
        reportedDates = repDoc.data().dates.map(standardizeDate);
    }
    
    // Ensure available dates are also standard
    let cleanAvailableDates = availableDates.map(standardizeDate);

    // Filter available dates: Remove if reported
    // Using simple string comparison after standardization
    const dates = cleanAvailableDates.filter(d => !reportedDates.includes(d));

    const fromSel = document.getElementById('historyDateFrom');
    const toSel = document.getElementById('historyDateTo');
    const tbody = document.querySelector('#historyTable tbody');
    const totalsBox = document.getElementById('historyTotals');

    tbody.innerHTML = '';

    if (dates.length === 0) {
        totalsBox.innerText = 'No unreported sales data';
        return;
    }

  // âœ… Fill dropdowns only once
  if (!fromSel.dataset.filled) {
    fromSel.innerHTML = '';
    toSel.innerHTML = '';
    
    // Use Set to remove duplicates after standardization
    const uniqueDates = [...new Set(dates)].sort();

    uniqueDates.forEach(d => {
      const opt1 = document.createElement('option');
      opt1.value = d;
      opt1.innerText = d;

      const opt2 = opt1.cloneNode(true);
      fromSel.appendChild(opt1);
      toSel.appendChild(opt2);
    });

    fromSel.value = uniqueDates[0];
    toSel.value   = uniqueDates[uniqueDates.length - 1];

    fromSel.dataset.filled = 'true';

    // âœ… Attach change events once
    fromSel.onchange = buildSalesHistory;
    toSel.onchange   = buildSalesHistory;
  }

  // 4. Client-side filtering for the table rows based on dropdown selection
  let filteredDocs = summaryDocs.filter(s => {
    const sDate = standardizeDate(s.date);
    const fDate = standardizeDate(fromSel.value);
    const tDate = standardizeDate(toSel.value);
    return sDate >= fDate && sDate <= tDate;
  });
  
  // Sort by Date
  filteredDocs.sort((a,b) => new Date(a.date) - new Date(b.date));

  let grandTotal = 0;
  let totSilver = 0, totSport = 0, totIndu = 0;

  // Build Table from Summaries
  filteredDocs.forEach(sum => {
      const silver = sum.Silver || 0;
      const sport = sum.Sportswear || 0;
      const indu  = sum.Indu || 0;
      
      totSilver += silver;
      totSport += sport;
      totIndu += indu;
      grandTotal += (sum.GrandTotal || 0);

      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="padding:8px;border:1px solid #cfe9ff;">${sum.date}</td>
        <td style="padding:8px;border:1px solid #cfe9ff;">${silver}</td>
        <td style="padding:8px;border:1px solid #cfe9ff;">${sport}</td>
        <td style="padding:8px;border:1px solid #cfe9ff;">${indu}</td>
      `;
      tbody.appendChild(row);
  });

  // âœ… Totals row
  const totalRow = document.createElement('tr');
  totalRow.style.fontWeight = 'bold';
  totalRow.innerHTML = `
    <td style="padding:8px;border:1px solid #cfe9ff;">Total</td>
    <td style="padding:8px;border:1px solid #cfe9ff;">${totSilver}</td>
    <td style="padding:8px;border:1px solid #cfe9ff;">${totSport}</td>
    <td style="padding:8px;border:1px solid #cfe9ff;">${totIndu}</td>
  `;
  tbody.appendChild(totalRow);

  // Load Expenses (No Change Needed)
  const expenseListDiv = document.getElementById('expenseList');
  expenseListDiv.innerHTML = '';

  const expenses = (await getExpensesOnce())
    .filter(e => e.cashier === currentUser.name);

  if (expenses.length === 0) {
    if(isViewingReport){
        document.getElementById("List-txt").innerText = "Expenses List:";
    } else {
        document.getElementById("List-txt").innerText = "No Expenses";
    }
  } else {
    document.getElementById("List-txt").innerText = "Expenses List:";
  }

  let totalExpenses = 0;

  expenses.forEach(e => {
    const div = document.createElement('div');
    div.style.padding = '6px';
    div.style.borderBottom = '1px solid #e6f7ff';
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';

    const text = document.createElement('span');
    text.innerText = `${e.description}: â‚±${e.amount}`;
    div.appendChild(text);

    const delBtn = document.createElement('button');
    delBtn.innerText = 'X';
    delBtn.style.background = 'var(--danger)';
    delBtn.style.color = '#fff';
    delBtn.style.border = 'none';
    delBtn.style.borderRadius = '4px';
    delBtn.style.padding = '2px 6px';

    delBtn.onclick = async () => {
      if (!confirm('Delete this expense?')) return;
      await deleteDoc(doc(db, 'expenses', e.id));
      expensesCache = null;
      await buildSalesHistory();
    };

    div.appendChild(delBtn);
    expenseListDiv.appendChild(div);

    totalExpenses += e.amount;
  });

  // âœ… Final totals
  totalsBox.innerText = `Grand Total: â‚±${grandTotal}\nExpenses: â‚±${totalExpenses}\nNet: â‚±${grandTotal - totalExpenses}`;

  //Report Confirm
  document.getElementById('reportSum').innerHTML = `Report Summary: <br> <br>
     Date: ${fromSel.value} - ${toSel.value} <br>
     Grand Total: â‚±${grandTotal} <br>
     Expenses:    â‚±${totalExpenses} <br>
     Net:         â‚±${grandTotal - totalExpenses} <br>`;
}

async function makeReport() {
  const from = document.getElementById('historyDateFrom').value;
  const to   = document.getElementById('historyDateTo').value;

  // FETCH RANGE
  let sales = await fetchSalesByRange(from, to);
  
  // Filter for user
  sales = sales.filter(s => s.cashier === currentUser.name);

  if (sales.length === 0) {
    alert('No sales to report');
    return;
  }

  const expenses = (await getExpensesOnce())
  .filter(e => e.cashier === currentUser.name);


  let grandTotal = 0;
  sales.forEach(s => grandTotal += s.total);

  let totalExpenses = 0;
  expenses.forEach(e => totalExpenses += e.amount);

  const net = grandTotal - totalExpenses;

  // SAVE REPORT
  await addDoc(collection(db, 'reports'), {
    cashier: currentUser.name,
    fromDate: from,
    toDate: to,
    sales,
    expenses,
    grandTotal,
    totalExpenses,
    net,
    createdAt: new Date()
  });

  // MARK SALES AS REPORTED
  const dateRange = [];
  sales.forEach(s => {
    // ðŸ›‘ FIX: Use strict YYYY-MM-DD from the sale record or force it
    // This matches the sales_counter and dropdown format exactly.
    let d;
    if(s.dateKey) {
        d = s.dateKey;
    } else {
        const dateObj = new Date(s.date);
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        d = `${year}-${month}-${day}`;
    }
    
    // Normalize before pushing
    d = standardizeDate(d);

    if (!dateRange.includes(d)) dateRange.push(d);
  });

  // âœ… CASE INSENSITIVE REPORT SAVING
  // Find the correct document even if casing is mismatched
  const repSnap = await getDocs(collection(db, 'reported_dates'));
  let repDoc = repSnap.docs.find(d => d.id === currentUser.name);
  if(!repDoc) {
      repDoc = repSnap.docs.find(d => d.id.toLowerCase() === currentUser.name.toLowerCase());
  }

  // Use the ID found (or default to current user name if creating new)
  const finalDocId = repDoc ? repDoc.id : currentUser.name;
  const repRef = doc(db, 'reported_dates', finalDocId);

  let existingDates = [];
  if (repDoc && repDoc.data().dates) {
    existingDates = repDoc.data().dates;
  }

  // merge old + new (no duplicates)
  // Ensure we standardize existing dates too before saving back
  const cleanExistingDates = existingDates.map(standardizeDate);
  const mergedDates = [...new Set([...cleanExistingDates, ...dateRange])];

  await setDoc(repRef, {
    dates: mergedDates
  });

  alert('Report saved!');
  // ðŸ§¹ CLEAR EXPENSES AFTER REPORT
const expSnap = await getDocs(collection(db, 'expenses'));
for (const d of expSnap.docs) {
  if (d.data().cashier === currentUser.name) {
    await deleteDoc(doc(db, 'expenses', d.id));
    expensesCache = null;
  }
}

  closeSalesHistory();
}



/* ---------- INIT ---------- */


// ===== SAFE ONE-TIME FETCHERS =====
async function getProductsOnce(force = false) {
  if (productsCache && !force) return productsCache;
  const snap = await getDocs(collection(db, 'products'));
  productsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  return productsCache;
}

async function getSalesOnce(force = false) {
  if (salesCache && !force) return salesCache;
  const snap = await getDocs(collection(db, 'sales'));
  salesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  return salesCache;
}

async function getExpensesOnce(force = false) {
  if (expensesCache && !force) return expensesCache;
  const snap = await getDocs(collection(db, 'expenses'));
  expensesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  return expensesCache;
}

async function getCashiersOnce(force = false) {
  if (cashiersCache && !force) return cashiersCache;
  const snap = await getDocs(collection(db, 'cashiers'));
  cashiersCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  return cashiersCache;
}



(async function initOnLoad() {
  // Firestore collections auto-created; nothing needed here
})();
document.addEventListener('DOMContentLoaded', async () => {
  const savedUser = localStorage.getItem('loggedInUser');
  if (!savedUser) return;

  currentUser = JSON.parse(savedUser);

  if (currentUser.role === 'admin') {
    document.getElementById('login').classList.add('hidden');
    document.getElementById('adminPage').classList.remove('hidden');
    showSection('inventory');
    await loadInventory();
    await loadCashiers();
    await loadSales();
    
    loadCartFromStorage();
    renderCart();

  }

  if (currentUser.role === 'cashier') {
    document.getElementById('login').classList.add('hidden');
    document.getElementById('cashierPage').classList.remove('hidden');
    document.getElementById('cashierNameDisplay').innerText = currentUser.name;
    await loadSettings();
    await loadProducts();
    await loadDailySales();
    
    // ðŸŒŸ RE-ATTACH LISTENER ON PAGE REFRESH
    monitorCashierStatus();

    loadCartFromStorage();
    renderCart();
  }
});


const themeToggle = document.getElementById('themeToggle');

 themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-theme');
  
  if(document.body.classList.contains('dark-theme')) {
    themeToggle.innerText = 'â˜€ï¸ Light Mode';
    localStorage.setItem('theme', 'dark');
  } else {
    themeToggle.innerText = 'ðŸŒ™ Dark Mode';
    localStorage.setItem('theme', 'light');
  }
});

// âœ… Load saved theme on page load
const savedTheme = localStorage.getItem('theme');
if(savedTheme === 'dark') {
  document.body.classList.add('dark-theme');
  themeToggle.innerText = 'â˜€ï¸Light Mode';
}


function openReportPassword() {
  document.getElementById('reportPassword').value = '';
  document.getElementById('reportPasswordModal').style.display = 'flex';
}



function closeReportPassword() {
  document.getElementById('reportPasswordModal').style.display = 'none';
}

async function confirmMakeReport() {
  const entered = document.getElementById('reportPassword').value;

  // verify cashier password
  const cashiers = await getCashiersOnce();
  const cashier = cashiers.find(c => c.username === currentUser.name);


  if (!cashier || cashier.password !== entered) {
    alert('Incorrect password');
    return;
  }

  closeReportPassword();
  await makeReport();
}

function openExpenseModal() {
  document.getElementById('expenseDesc').value = '';
  document.getElementById('expenseAmount').value = '';
  document.getElementById('expenseModal').style.display = 'flex';
}

function closeExpenseModal() {
  document.getElementById('expenseModal').style.display = 'none';
}

async function saveExpense() {
  const desc = document.getElementById('expenseDesc').value.trim();
  const amt = parseFloat(document.getElementById('expenseAmount').value);

  if (!desc) {
    alert('Please enter description');
    return;
  }

  if (isNaN(amt) || amt <= 0) {
    alert('Please enter a valid amount');
    return;
  }

  await addDoc(collection(db, 'expenses'), {
    cashier: currentUser.name,
    description: desc,
    amount: amt,
    date: new Date().toISOString()
  });

  expensesCache = null;
  closeExpenseModal();
  await buildSalesHistory();
}

// =======================================================
// âœ… MODIFIED: loadReports with CASHIER FILTER
// =======================================================
async function loadReports() {
  const list = document.getElementById('reportList');
  const filterSelect = document.getElementById('reportCashierFilter');
  
  list.innerHTML = 'Loading...';

  // 1. Fetch Reports
  const snap = await getDocs(collection(db, 'reports'));

  // Convert to array + sort by createdAt (NEWEST FIRST)
  const allReports = snap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .sort((a, b) => {
      const aTime = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
      const bTime = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
      return bTime - aTime;
    });

  // 2. Populate Cashier Dropdown (Only if not already populated)
  // We check length > 1 because "All Cashiers" is index 0
  if (filterSelect.options.length <= 1) {
      const cashiers = await getCashiersOnce();
      cashiers.forEach(c => {
          // Avoid duplicates in dropdown
          let exists = false;
          for(let i=0; i<filterSelect.options.length; i++){
              if(filterSelect.options[i].value === c.username) exists = true;
          }
          
          if(!exists){
              const opt = document.createElement('option');
              opt.value = c.username;
              opt.innerText = c.username;
              filterSelect.appendChild(opt);
          }
      });
  }

  // 3. Define Render Function
  function renderList() {
      const selectedCashier = filterSelect.value;
      list.innerHTML = '';

      // Filter Logic
      const filteredReports = selectedCashier === 'All' 
          ? allReports 
          : allReports.filter(r => r.cashier === selectedCashier);

      if (filteredReports.length === 0) {
          list.innerHTML = '<p style="text-align:center; padding:20px;">No reports found for this selection.</p>';
          return;
      }

      filteredReports.forEach(r => {
        const created = r.createdAt?.toDate
          ? r.createdAt.toDate()
          : new Date(r.createdAt);

        const div = document.createElement('div');
        div.style.background = 'var(--card)';
        div.style.padding = '12px';
        div.style.borderRadius = '10px';
        div.style.boxShadow = '0 2px 6px rgba(0,0,0,0.06)';
        div.style.marginBottom = '10px';
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <strong>Cashier:</strong> ${r.cashier}<br>
              <span>${r.fromDate} - ${r.toDate}</span><br>
              <small style="color:gray;">
                Submitted: ${created.toLocaleString()}
              </small>
            </div>
            <button onclick="viewReport('${r.id}')">View</button>
          </div>
        `;
        list.appendChild(div);
      });
  }

  // 4. Attach Event Listener for Filter
  filterSelect.onchange = renderList;

  // 5. Initial Render
  renderList();
}
// =======================================================


async function viewReport(id) {
  isViewingReport = true;

  const snap = await getDocs(collection(db, 'reports'));
  const reportDoc = snap.docs.find(d => d.id === id);
  if (!reportDoc) return alert('Report not found');

  const report = reportDoc.data();

  document.getElementById('salesHistoryModal').style.display = 'flex';

  // Disable controls
  document.getElementById('sales-history-dd').style.display = 'none';
  document.getElementById('historyDateFrom').disabled = true;
  document.getElementById('historyDateTo').disabled = true;
  document.getElementById('addExpenseBtn').style.display = 'none';
  document.getElementById('makeReportBtn').style.display = 'none';
  
  // Clear UI
  document.querySelector('#historyTable tbody').innerHTML = '';
  document.getElementById('expenseList').innerHTML = '';

  // Build table from REPORT DATA
  const tbody = document.querySelector('#historyTable tbody');
  const map = {};

  report.sales.forEach(s => {
    const date = new Date(s.date).toLocaleDateString();
    if (!map[date]) map[date] = { Silver: 0, Sportswear: 0, Indu: 0 };

    s.products.forEach(p => {
      map[date][p.category] += p.qty * p.price;
    });
  });

  Object.keys(map).forEach(date => {
    const r = map[date];
    const tr = document.createElement('tr');
    tr.innerHTML = `
       <td style="padding:8px;border:1px solid #cfe9ff;">${date}</td>
      <td style="padding:8px;border:1px solid #cfe9ff;">${r.Silver}</td>
      <td style="padding:8px;border:1px solid #cfe9ff;">${r.Sportswear}</td>
      <td style="padding:8px;border:1px solid #cfe9ff;">${r.Indu}</td>
    `;
    tbody.appendChild(tr);
  });

  // Expenses (READ-ONLY)
  let totalExpenses = 0;
  report.expenses.forEach(e => {
    const div = document.createElement('div');
    div.innerText = `${e.description}: â‚±${e.amount}`;
    document.getElementById('expenseList').appendChild(div);
    totalExpenses += e.amount;
  });

  document.getElementById('historyTotals').innerText =
    `Grand Total: â‚±${report.grandTotal}
   Expenses: â‚±${report.totalExpenses}
   Net: â‚±${report.net}`;
}


// ========== NEW FIX FUNCTION ==========
// Run this once in your browser console: window.fixDateFormat()
window.fixDateFormat = async function() {
  console.log("Starting Date Format Fix...");
  const snap = await getDocs(collection(db, "sales"));
  let count = 0;
  
  for (const d of snap.docs) {
    const data = d.data();
    const oldDate = data.date;

    // Detect if date starts with "1" (like 12/8/2025) or isn't strict ISO
    if (typeof oldDate === 'string' && !oldDate.startsWith("20")) {
      const dateObj = new Date(oldDate);
      if (!isNaN(dateObj.getTime())) {
        const newISO = dateObj.toISOString();
        
        // Fix the date format
        await updateDoc(doc(db, "sales", d.id), {
           date: newISO,
           saleDate: newISO 
        });
        console.log(`Fixed: ${oldDate} -> ${newISO}`);
        count++;
      }
    }
  }
  alert(`Fixed ${count} sales records! Refresh the page now.`);
};

// ================= MIGRATION TOOL =================
// ðŸš¨ RUN THIS ONCE IN CONSOLE TO FIX HISTORY ðŸš¨
window.migrateDailySummaries = async function() {
    console.log("Starting Daily Summary Migration...");
    
    // 1. Fetch ALL sales
    const salesSnap = await getDocs(collection(db, 'sales'));
    const sales = salesSnap.docs.map(d => d.data());
    
    // 2. Aggregate locally
    const summaries = {}; // Key: "2025-12-28_CashierName"

    sales.forEach(s => {
        let dateKey;
        if(s.dateKey) {
            dateKey = s.dateKey;
        } else {
            // Fallback for old data
            const d = new Date(s.date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            dateKey = `${year}-${month}-${day}`;
        }

        const key = `${dateKey}_${s.cashier}`;
        
        if(!summaries[key]) {
            summaries[key] = {
                date: dateKey,
                cashier: s.cashier,
                GrandTotal: 0,
                Silver: 0,
                Sportswear: 0,
                Indu: 0
            };
        }

        summaries[key].GrandTotal += s.total;
        
        s.products.forEach(p => {
            if(!summaries[key][p.category]) summaries[key][p.category] = 0;
            summaries[key][p.category] += (p.qty * p.price);
        });
    });

    // 3. Write to Firestore (Batch)
    const batch = writeBatch(db);
    let count = 0;
    
    for (const key in summaries) {
        const ref = doc(db, 'daily_summaries', key);
        batch.set(ref, summaries[key], { merge: true });
        count++;
    }

    await batch.commit();
    alert(`Migration Complete! Created ${count} summary records.`);
};

// ================= REPORTED DATES FIX TOOL =================
// ðŸš¨ RUN THIS ONCE IN CONSOLE TO FIX OLD "12/28/2025" FORMATS ðŸš¨
window.fixReportedDates = async function() {
    console.log("Fixing reported dates format...");
    const snap = await getDocs(collection(db, 'reported_dates'));
    let count = 0;

    for (const d of snap.docs) {
        const data = d.data();
        if (!data.dates || !Array.isArray(data.dates)) continue;

        const newDates = [];
        let changed = false;

        data.dates.forEach(dateStr => {
            // Check if it looks like MM/DD/YYYY (contains slashes)
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // Ensure padding (e.g., 9 -> 09)
                    const m = parts[0].padStart(2, '0');
                    const day = parts[1].padStart(2, '0');
                    const y = parts[2];
                    // Convert to YYYY-MM-DD
                    newDates.push(`${y}-${m}-${day}`);
                    changed = true;
                } else {
                    newDates.push(dateStr); // Keep if weird format
                }
            } else {
                newDates.push(dateStr); // Already correct or ISO
            }
        });

        if (changed) {
            // Remove duplicates while we are at it
            const uniqueDates = [...new Set(newDates)];
            await updateDoc(doc(db, 'reported_dates', d.id), {
                dates: uniqueDates
            });
            console.log(`Fixed ${d.id}:`, uniqueDates);
            count++;
        }
    }
    alert(`Fixed reported dates for ${count} cashiers!`);
};


// Expose functions to global scope for HTML onclick
window.login = login;
window.logout = logout;
window.showSection = showSection;
window.toggleAddProduct = toggleAddProduct;
window.addProduct = addProduct;
window.addCashier = addCashier;
window.deleteCashier = deleteCashier;
window.openModal = openModal;
window.openCustomModal = openCustomModal;
window.closeModal = closeModal;
window.decreaseQty = decreaseQty;
window.increaseQty = increaseQty;
window.modalAddToCart = modalAddToCart;
window.removeCartItem = removeCartItem;
window.checkout = checkout;
window.openSalesHistory = openSalesHistory;
window.closeSalesHistory = closeSalesHistory;
window.managePanel = managePanel;
window.adminPanel = adminPanel;
window.editProduct = editProduct;
window.closeEditModal = closeEditModal;
window.saveEditProduct = saveEditProduct;
window.openReportPassword = openReportPassword;
window.closeReportPassword = closeReportPassword;
window.confirmMakeReport = confirmMakeReport;
window.viewReport = viewReport;
window.openExpenseModal = openExpenseModal;
window.closeExpenseModal = closeExpenseModal;
window.saveExpense = saveExpense;

// NEW EXPORTS
window.openEditCashierModal = openEditCashierModal;
window.closeEditCashierModal = closeEditCashierModal;
window.saveEditCashier = saveEditCashier;
window.toggleCashierStatus = toggleCashierStatus;
window.closeAccessDenied = closeAccessDenied;
</script>
</body>
</html>
