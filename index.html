<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WearTrack POS</title>
<style>
/* ---------- PASTEL BLUE THEME + layout ---------- */
:root{
 --bg: #e6f3ff;
 --card: #ffffff;
 --primary: #7fb7ff;
 --primary-dark: #5ea8ff;
 --muted: #5a6b7a;
 --danger: #ff6b6b;
 --accent-ghost: #dff1ff;
}

* { box-sizing: border-box;}

body {
 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 margin:0; padding:0;
 background: var(--bg);
 color: var(--muted);
 -webkit-font-smoothing:antialiased;
}

.container { max-width:1200px; margin:auto; padding:10px; }

h2, h3 { text-align:center; color: #4d8ed3; margin:8px 0; }
button {
 padding:6px 12px; border:none; border-radius:6px;
 background:var(--primary); color:white; cursor:pointer; transition:0.16s;
 box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}
button:hover { background:var(--primary-dark); transform: translateY(-1px); }
input, select {
 width:100%; padding:10px; margin:6px 0;
 border:1px solid #cfe9ff; border-radius:6px;
 background: white;
}
.hidden { display:none; }

/* ---------- SECTIONS ---------- */
.section { margin-top:18px; }
#inventoryList div, #cashierList div {
 margin-bottom:10px; padding:10px;
  background:var(--card); border-radius:8px;
 box-shadow:0 2px 5px rgba(0,0,0,0.06);
 display:flex; justify-content:space-between; align-items:center;
}

/* ---------- POS LAYOUT ---------- */
#pos { display:flex; flex-wrap:wrap; gap:12px; margin-top:10px; align-items:flex-start; }
#productGrid {
 display:grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr));
 gap:12px; flex:2; max-height:640px; overflow-y:auto; padding-right:6px; ;
}
.product {
  background:var(--card); border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
  cursor:pointer; display:flex; flex-direction:column; align-items:center; padding:10px; text-align:center;
  transition:0.14s;
}
.product:hover { transform:translateY(-4px); box-shadow:0 6px 16px rgba(0,0,0,0.08); }

#cart {
  flex:1.5; background:var(--card); padding:12px; border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.06); max-height:640px; display:flex; flex-direction:column;
  min-width:250px;
}
#cart table { width:100%; border-collapse:collapse; margin-bottom:12px; }
#cart th, #cart td { border-bottom:1px solid #eef6ff; padding:6px; text-align:left; font-size:14px; color:var(--muted); }
#cart th { background:var(--accent-ghost); }

/* ---------- MODAL ---------- */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.35); justify-content:center; align-items:center; z-index:8000; }
.modal-content { background:var(--card); padding:18px; border-radius:12px; width:92%; max-width:420px; box-shadow:0 8px 24px rgba(0,0,0,0.12); }
.qty-buttons { display:flex; align-items:center; gap:6px; }
.qty-buttons button { width:34px; }

/* ---------- CATEGORY BUTTONS ---------- */
#adminCategoryButtons button, #cashierCategoryButtons button { margin-right:6px; margin-bottom:8px; background:var(--primary); }
#adminCategoryButtons button:hover, #cashierCategoryButtons button:hover { background:var(--primary-dark); }

#cashierCategoryButtons button {
  background: transparent;
  border: 2px solid var(--primary);
  color: var(--primary-dark);
  font-weight: 600;
}


#cashierCategoryButtons button.active-cat {
  background: var(--primary-dark);
  color: white;
  border-color: var(--primary-dark);
}


/* ---------- DAILY SALES ---------- */
#dailySalesList div, #salesList div { background:var(--card); padding:10px; border-radius:8px; margin-bottom:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
.small-x { display:flex; align-items:center; justify-content:center; background:var(--danger); color:white; border-radius:25%; width:26px; height:26px; font-weight:bold; border:none; cursor:pointer; }

#cashierCategoryButtons button {
  background: transparent;
  border: 2px solid var(--primary);
  color: var(--primary-dark);
  font-weight: 600;
}

#cashierCategoryButtons button:hover {
  background: var(--accent-ghost);
}

#cashierCategoryButtons button.active-cat {
  background: var(--primary-dark);
  color: white;
  border-color: var(--primary-dark);
}

.menuBtn{
   width: 20px;
}
#side-panel{
   position: fixed;
   right: -500px;
   top: 0;
   bottom: 0;
   width: 300px;
   background-color: var(--muted);
   z-index: 8000;
   transition: right 0.3s ease-in-out;
}

#side-panel.active{
   right: 0;
}

.panel-btn{
   display: flex;
   flex-direction: column;
   gap: 10px;
   padding: 0 8px;
}
.panel-btn button{
   height: 50px;
}

/* ---------- RESPONSIVE ---------- */
@media(max-width:900px){
 #pos { flex-direction:column; gap:10px; }
 #productGrid { max-height:none; width:100%; }
 #cart { max-height:none; width:100%; margin-top:10px;}
}

@media(max-width:450px){
   /*.cashier-text{font-size:17px;}*/
}

/* Custom Transaction Card */
.custom-product {
  background: var(--card);
}

/* Dark theme support */
body.dark-theme .custom-product {
  background: var(--card);
}
body.dark-theme #side-panel{
   background-color: #515151;
}

body.dark-theme  {
  --bg: #121212;
  --card: #1e1e1e;
  --primary: #4a90e2;
  --primary-dark: #357ab7;
  --muted: #8e8e8e;
  --danger: #ff6b6b;
  --accent-ghost: #2a2a2a;
  color: var(--muted);
  background: var(--bg);
}

body.dark-theme input,
body.dark-theme select {
  background: #2a2a2a;
  color: #fff;
  border: 1px solid #444;
}

body.dark-theme button {
  color: white;
}

body.dark-theme #cart,
body.dark-theme #productGrid div,
body.dark-theme #inventoryList div,
body.dark-theme #cashierList div {
  background: var(--card);
  color: var(--muted);
}

</style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="container">
 <h2>Densio POS Login</h2>
  <input type="text" id="username" placeholder="Username">
 <input type="password" id="password" placeholder="Password">
 <button onclick="login()" style="width:100%; height:50px; margin-top:15px">Login</button>
 <p id="loginMsg" style="color:crimson;"></p>
</div>

<!-- ADMIN PAGE -->
<div id="adminPage" class="container hidden">
   <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>Admin Dashboard</h2>
    <button onclick="logout()">Logout</button>
   </div>
   <div style="margin-top:20px">
    <button onclick="showSection('inventory')">Inventory</button>
    <button onclick="showSection('cashiers')">Cashiers</button>
    <button onclick="showSection('salesSummary')">Sales Summary</button>
    <button onclick="showSection('settings')">Settings</button>
    <button onclick="showSection('reports')">Reports</button>
   </div>


 <div id="inventory" class="hidden section">
   <h3>Inventory</h3>
   <button onclick="toggleAddProduct()">Add Product</button>
   <div id="addProductForm" class="hidden">
    <input type="text" id="prodName" placeholder="Product Name">
      <select id="prodCat">
        <option value="">Select Category</option>
        <option value="Sportswear">Sportswear</option>
        <option value="Silver">Silver</option>
        <option value="Indu">Indu</option>
     </select>
     <input type="number" id="prodPrice" placeholder="Price">
     <input type="number" id="prodStock" placeholder="Stock Quantity">
Â  Â  Â  <button onclick="addProduct()">Add</button>
Â  Â  </div>
Â  Â  <div id="inventoryList"></div>
Â  </div>

Â  <div id="cashiers" class="hidden section">
Â  Â  <h3>Cashiers</h3>
Â  Â  <input type="text" id="cashierName" placeholder="Cashier Username">
Â  Â  <input type="password" id="cashierPass" placeholder="Password">
Â  Â  <button onclick="addCashier()" style="margin-bottom:10px; height:40px; width:100%">Add Cashier</button>
   <div id="cashierList"></div>
 </div>

  <div id="salesSummary" class="hidden section">
Â  Â  <h3>Sales Summary</h3>
   <div style="display:flex; gap:10px; margin-bottom:10px;">
  <div style="flex:1;">
    <label>From:</label>
    <select id="adminDateFrom"></select>
  </div>
  <div style="flex:1;">
    <label>To:</label>
    <select id="adminDateTo"></select>
  </div>
</div>

<div style="margin-bottom:10px;">
  <label>Cashier:</label>
  <select id="adminCashierFilter">
    <option value="All">All Cashiers</option>
  </select>
</div>


<div id="adminCategoryButtons"></div>
<div id="adminGrandTotal" style="font-weight:800; margin:20px 0;">Total: â‚±0</div>
<div id="salesList"></div>
Â  </div>

  <div id="settings" class="hidden section">
  <h3>POS Settings</h3>
  <div id="settingsList" style="display:flex; flex-direction:column; gap:10px;"></div>
</div>
Â  <div id="reports" class="hidden section">
  <h3>Report List</h3>
  <div id="reportList"></div>
</div>
</div>

<!-- CASHIER PAGE -->
<div id="cashierPage" class="container hidden">
<div id="cashierHeader" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
  <h2 class="cashier-text">Cashier POS</h2>
  <div class="lag" style="display:flex; gap:5px;">
     <button onclick="managePanel()">
     <img class="menuBtn" src="Image/Menu.png" alt="Image/Menu.png">
     </button>
  </div>
</div>
<div id="side-panel" style="">
   <div style="display:flex; justify-content:space-between; align-items:center; padding: 10px 10px;">
      <h1 style="color: #f6f6f6; font-size: 20px">Cashier: <strong id="cashierNameDisplay"></strong></h1>
      <button onclick="managePanel()" style="width:40px; height:40px;">X</button>
   </div>
   <div class="panel-btn" style="margin-top:50px">
    <button onclick="openSalesHistory()">Sales History</button>
     <button id="themeToggle"> ðŸŒ™ Dark Mode</button>
    <button onclick="logout()">Logout</button>
   </div>
</div>
<!-- ADD EXPENSE MODAL -->
<div id="expenseModal" class="modal" style="z-index: 9999999">
  <div class="modal-content">
    <h3>Add Expense</h3>

    <label>Description</label>
    <input type="text" id="expenseDesc" placeholder="e.g. Transportation">

    <label>Amount</label>
    <input type="number" id="expenseAmount" placeholder="e.g. 150">

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button style="flex:1;" onclick="saveExpense()">Save</button>
      <button style="flex:1; background:#eee; color:#333;" onclick="closeExpenseModal()">Cancel</button>
    </div>
  </div>
</div>

Â  <div id="cashierCategoryButtons"></div>
Â  <div id="pos">
Â  Â  <div id="productGrid"></div>
Â  Â  <div id="cart">
Â  Â  Â  <h3>Cart</h3>
Â  Â  Â  <table id="cartTable">
Â  Â  Â  Â  <tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th>Remove</th></tr>
Â  Â  Â  </table>
Â  Â  Â  <p style="font-weight:700; margin-top:8px;">Total: â‚±<span id="cartTotal">0</span></p>
Â  Â  Â  <button onclick="checkout()" style="height:50px">Checkout</button>
Â  Â  </div>
Â  </div>
Â  
  <div id="dailySummary" class="section">
     <h3>Daily Sales</h3>
     <div id="dailyCategoryButtons" style="margin-bottom:10px;"></div>
     <div id="dailyTotalBox" style="font-weight:800; margin:20px 0;">Daily Total: â‚±0</div>
     <div id="dailySalesList"></div>
   </div>

</div>

<!-- SALES HISTORY MODAL -->
<div id="salesHistoryModal" class="modal">
  <div class="modal-content" style="max-width:800px; overflow-y:auto; max-height:100%">
    <div style="margin-top:12px; text-align:right;">
      <button onclick="closeSalesHistory()">Close</button>
    </div>
    <h3 style="text-align:center;">Sales History</h3>

    <div id="sales-history-dd" style="display:flex; gap:10px; margin-bottom:10px;">
      <div style="flex:1;" >
        <label>From:</label>
        <select id="historyDateFrom"></select>
      </div>
      <div style="flex:1;">
        <label>To:</label>
        <select id="historyDateTo"></select>
      </div>
    </div>

    <div style="overflow-x:auto;">
      <table id="historyTable" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#dff1ff;">
            <th style="padding:8px;border:1px solid #cfe9ff;">Date</th>
            <th style="padding:8px;border:1px solid #cfe9ff;">Silver</th>
            <th style="padding:8px;border:1px solid #cfe9ff;">Sportswear</th>
            <th style="padding:8px;border:1px solid #cfe9ff;">Indu</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-top:12px;">
  <button id="addExpenseBtn" onclick="openExpenseModal()">+ Add Expense</button>
  <p id="List-txt"></p>
</div>

<div id="expenseList" style="margin-top:10px;"></div>
<div style="display:flex; justify-content:space-between; align-itemscenter;">
   <div id="historyTotals" style="margin-top:12px; font-weight:700; ">
   </div>
   <div style="display:flex; align-items:end">
       <button id="makeReportBtn" style="padding:12px" onclick="openReportPassword()">Make Report</button>
   </div>
</div>
  </div>
</div>
<div id="reportPasswordModal" class="modal" >
  <div class="modal-content" style="border: 1px solid #cccccc">
    <h3>Confirm Report</h3>
    <input type="password" id="reportPassword" placeholder="Enter your password">
    <div style="margin-top:10px">
    <button onclick="confirmMakeReport()">Confirm</button>
    <button onclick="closeReportPassword()">Cancel</button>
    </div>
  </div>
</div>


<!-- MODAL -->
<div id="productModal" class="modal" >
Â  <div class="modal-content">
Â  Â  <h3 id="modalName"></h3>
Â  Â  <div id="customNameDiv" style="display:none; margin-bottom:8px;">
Â  Â  Â  Product Name: <input type="text" id="modalCustomName" placeholder="Enter product name">
Â  Â  </div>
Â  Â  <div style="margin-bottom:8px;">Price: â‚±<input type="number" id="modalPrice" value="0" style="width:110px; display:inline-block; margin-left:6px;"></div>
Â  Â  <div class="qty-buttons" style="margin-bottom:10px;">
Â  Â  Â  <button onclick="decreaseQty()">-</button>
Â  Â  Â  <input type="number" id="modalQty" value="1" style="width:60px; text-align:center;">
Â  Â  Â  <button onclick="increaseQty()">+</button>
Â  Â  </div>
Â  Â  <div style="display:flex; gap:8px;">
Â  Â  Â  <button style="flex:1;" onclick="modalAddToCart()">Add to Cart</button>
Â  Â  Â  <button style="flex:1; background:#f0f0f0; color:var(--muted);" onclick="closeModal()">Cancel</button>
Â  Â  </div>
Â  </div>
</div>

<!-- EDIT PRODUCT MODAL -->
<div id="editProductModal" class="modal">
  <div class="modal-content">
    <h3>Edit Product</h3>

    <input type="hidden" id="editProdId">

    <label>Product Name</label>
    <input type="text" id="editProdName">

    <label>Category</label>
    <select id="editProdCat">
      <option value="Sportswear">Sportswear</option>
      <option value="Silver">Silver</option>
      <option value="Indu">Indu</option>
    </select>

    <label>Price</label>
    <input type="number" id="editProdPrice">

    <label>Stock</label>
    <input type="number" id="editProdStock">

    <div style="display:flex; gap:10px; margin-top:10px;">
      <button style="flex:1;" onclick="saveEditProduct()">Save</button>
      <button style="flex:1; background:#eee; color:#333;" onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>


<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, deleteDoc,
  doc, updateDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ===== YOUR FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDv0y5aS1ldtZlNfYZ5IsRhGsrSQaX45MA",
  authDomain: "weartrack-c71ab.firebaseapp.com",
  projectId: "weartrack-c71ab",
  storageBucket: "weartrack-c71ab.firebasestorage.app",
  messagingSenderId: "713165835734",
  appId: "1:713165835734:web:a0f2e71bd045ffb4f86877"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);



/* ---------- GLOBAL ---------- */

// ===== FIRESTORE CACHES (READ OPTIMIZATION) =====
let productsCache = null;
let salesCache = null;
let expensesCache = null;
let cashiersCache = null;

let currentUser = null;
let isViewingReport = false;
let cart = [];
let modalProductIndex = null;
let isAddingToCart = false;
let isRemovingItem = {};
let currentAdminFilter = 'All';
let currentAdminCashier = 'All';
let currentCashierCategory = 'Sportswear';
let currentDailyCategory = 'All';
const fixedCategories = ['Sportswear','Silver','Indu'];
let customCategoryStatus = {
  Sportswear: true,
  Silver: true,
  Indu: true
};


/* ---------- LOGIN ---------- */
async function login() {
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  const msg = document.getElementById('loginMsg');
  if (u === 'Admin' && p === 'admin') {
    currentUser = { role: 'admin', name: 'admin' };
localStorage.setItem('loggedInUser', JSON.stringify(currentUser));

    document.getElementById('login').classList.add('hidden');
    document.getElementById('adminPage').classList.remove('hidden');
    showSection('inventory');
    await loadInventory();
    await loadCashiers();
    await loadSales();
    msg.innerText = '';
    return;
  }
  const cashiers = await getCashiersOnce();
  const cashier = cashiers.find(c => c.username === u && c.password === p);

  if (cashier) {
  currentUser = { role: 'cashier', name: u };
  localStorage.setItem('loggedInUser', JSON.stringify(currentUser));

  document.getElementById('login').classList.add('hidden');
  document.getElementById('cashierPage').classList.remove('hidden');

  // âœ… ADD THIS LINE
  document.getElementById('cashierNameDisplay').innerText = currentUser.name;

  await loadSettings();
  await loadProducts();
  await loadDailySales();
  msg.innerText = '';
  return;
}
}

window.managePanel = function () {
  document.getElementById("side-panel").classList.toggle("active");
};


function logout() {
  currentUser = null;
  cart = [];
  localStorage.removeItem('loggedInUser');
  document.getElementById('login').classList.remove('hidden');
  document.getElementById('adminPage').classList.add('hidden');
  document.getElementById('cashierPage').classList.add('hidden');
  document.getElementById('side-panel').classList.remove('active');
}


/* ---------- ADMIN ---------- */
function showSection(id) {
  ['inventory', 'cashiers', 'salesSummary', 'settings', 'reports']
    .forEach(sec => document.getElementById(sec).classList.add('hidden'));

  document.getElementById(id).classList.remove('hidden');

  if (id === 'settings') loadSettings();
  if (id === 'reports') loadReports(); // âœ… ADD THIS
}




function toggleAddProduct() {
  document.getElementById('addProductForm').classList.toggle('hidden');
}

async function loadSettings() {
  const settingsSnap = await getDocs(collection(db, 'settings'));

  const existing = {};
  settingsSnap.docs.forEach(docu => {
    existing[docu.id] = docu.data().enabled;
  });

  // Defaults if not yet saved
  fixedCategories.forEach(cat => {
    customCategoryStatus[cat] =
      existing[cat] !== undefined ? existing[cat] : true;
  });

  const list = document.getElementById('settingsList');
  list.innerHTML = '';

  fixedCategories.forEach(cat => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.background = 'var(--card)';
    row.style.padding = '12px';
    row.style.borderRadius = '10px';
    row.style.boxShadow = '0 2px 5px rgba(0,0,0,0.06)';

    const label = document.createElement('strong');
    label.innerText = `${cat} Custom Transaction`;

    const toggle = document.createElement('button');
    toggle.innerText = customCategoryStatus[cat] ? 'Enabled' : 'Disabled';
    toggle.style.background = customCategoryStatus[cat]
      ? 'var(--primary)'
      : 'var(--danger)';

    toggle.onclick = async () => {
  customCategoryStatus[cat] = !customCategoryStatus[cat];

  const docRef = doc(db, 'settings', cat);

  // âœ… Always save using the category name as the document ID
  await setDoc(docRef, {
    enabled: customCategoryStatus[cat]
  }, { merge: true });

  await loadSettings();
  await loadProducts();
};


    row.appendChild(label);
    row.appendChild(toggle);
    list.appendChild(row);
  });
}


/* ---------- INVENTORY ---------- */
async function loadInventory() {
  const products = await getProductsOnce();

  const list = document.getElementById('inventoryList'); list.innerHTML = '';
  products.forEach((p, i) => {
    const div = document.createElement('div');
    div.innerHTML = `
  <div>
    <strong>${p.name}</strong> (${p.category})<br>
    â‚±${p.price} | Stock: ${p.stock}
  </div>
  <div style="display:flex; gap:6px;">
    <button class="editBtn" data-id="${p.id}">Edit</button>
    <button class="delBtn" data-id="${p.id}">Delete</button>
  </div>
`;
    list.appendChild(div);
  });
  document.querySelectorAll('.delBtn').forEach(btn => {
    btn.addEventListener('click', function () {
      deleteProduct(this.dataset.id);
    });
  });
  document.querySelectorAll('.editBtn').forEach(btn => {
  btn.addEventListener('click', function () {
    editProduct(this.dataset.id);
  });
});
}

function closeEditModal() {
  document.getElementById('editProductModal').style.display = 'none';
}

async function saveEditProduct() {
  const id = document.getElementById('editProdId').value;
  const name = document.getElementById('editProdName').value.trim();
  const category = document.getElementById('editProdCat').value;
  const price = parseFloat(document.getElementById('editProdPrice').value);
  const stock = parseInt(document.getElementById('editProdStock').value);

  if (!name || !category || isNaN(price) || isNaN(stock)) {
    return alert('Please fill all fields!');
  }

  await updateDoc(doc(db, 'products', id), {
    name,
    category,
    price,
    stock
  });
  productsCache = null;

  closeEditModal();
  await loadInventory();

  if (!document.getElementById('cashierPage').classList.contains('hidden')) {
    await loadProducts();
  }
}


async function addProduct() {
  const n = document.getElementById('prodName').value.trim();
  const c = document.getElementById('prodCat').value;
  const price = parseFloat(document.getElementById('prodPrice').value);
  const stock = parseInt(document.getElementById('prodStock').value);
  if (!n || !c || !price || !stock) return alert('Please fill all required fields!');
  await addDoc(collection(db, 'products'), { name: n, category: c, price, stock });
  productsCache = null;
  await loadInventory();
  if (!document.getElementById('cashierPage').classList.contains('hidden')) await loadProducts();
  document.getElementById('prodName').value = '';
  document.getElementById('prodCat').value = '';
  document.getElementById('prodPrice').value = '';
  document.getElementById('prodStock').value = '';
}

async function deleteProduct(id) {
  if (confirm('Delete this product?')) {
    await deleteDoc(doc(db, 'products', id));
    productsCache = null;
    await loadInventory();
    if (!document.getElementById('cashierPage').classList.contains('hidden')) await loadProducts();
  }
}
async function editProduct(id) {
  const products = await getProductsOnce();
const product = products.find(p => p.id === id);
if (!product) return;

const data = product;

  document.getElementById('editProdId').value = id;
  document.getElementById('editProdName').value = data.name;
  document.getElementById('editProdCat').value = data.category;
  document.getElementById('editProdPrice').value = data.price;
  document.getElementById('editProdStock').value = data.stock;

  document.getElementById('editProductModal').style.display = 'flex';
}



/* ---------- CASHIERS ---------- */
async function loadCashiers() {
  const cashiersSnapshot = await getDocs(collection(db, 'cashiers'));
  const cashiers = cashiersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  const list = document.getElementById('cashierList'); list.innerHTML = '';
  cashiers.forEach((c, i) => {
    list.innerHTML += `<div>${c.username} <button onclick="editCashier('${c.id}')">Edit</button> <button onclick="deleteCashier('${c.id}')">Delete</button></div>`;
  });
}

async function addCashier() {
  const u = document.getElementById('cashierName').value.trim();
  const p = document.getElementById('cashierPass').value.trim();
  if (!u || !p) return alert('Fill all fields');
  await addDoc(collection(db, 'cashiers'), { username: u, password: p });
  await loadCashiers();
  document.getElementById('cashierName').value = '';
  document.getElementById('cashierPass').value = '';
}

async function deleteCashier(id) {
  if (confirm('Delete this cashier?')) {
    await deleteDoc(doc(db, 'cashiers', id));
    await loadCashiers();
  }
}






async function editCashier(id) {
  const newName = prompt('New username');
  const newPass = prompt('New password');
  if (newName && newPass) {
    await updateDoc(doc(db, 'cashiers', id), { username: newName, password: newPass });
    await loadCashiers();
  }
}

/* ---------- ADMIN SALES ---------- */
async function loadSales() {
  const catBtns = document.getElementById('adminCategoryButtons');

  catBtns.innerHTML = '';
  

  const allBtn = document.createElement('button');
  allBtn.innerText = 'All';
  allBtn.onclick = () => filterSales('All');
  catBtns.appendChild(allBtn);

  fixedCategories.forEach(cat => {
    const btn = document.createElement('button');
    btn.innerText = cat;
    btn.onclick = () => filterSales(cat);
    catBtns.appendChild(btn);
  });

  // âœ… Build Date Dropdown
  const sales = await getSalesOnce();
  
  // ---- Build Cashier Dropdown ----
const cashierSelect = document.getElementById('adminCashierFilter');
cashierSelect.innerHTML = '<option value="All">All Cashiers</option>';

const cashiers = await getCashiersOnce();
cashiers.forEach(c => {
  const opt = document.createElement('option');
  opt.value = c.username;
  opt.innerText = c.username;
  cashierSelect.appendChild(opt);
});

// Default
currentAdminCashier = 'All';

// Re-filter on change
cashierSelect.onchange = () => {
  currentAdminCashier = cashierSelect.value;
  filterSales(currentAdminFilter);
};

  
  

  const uniqueDates = [...new Set(
    sales.map(s => new Date(s.date).toLocaleDateString())
  )];

  // ---- Admin From-To Dropdown Build ----
const fromSel = document.getElementById('adminDateFrom');
const toSel   = document.getElementById('adminDateTo');

fromSel.innerHTML = "";
toSel.innerHTML = "";

// Sort oldest â†’ newest
uniqueDates.sort((a,b)=> new Date(a) - new Date(b));

uniqueDates.forEach(d => {
  const opt1 = document.createElement('option');
  opt1.value = d;
  opt1.innerText = d;
  fromSel.appendChild(opt1);

  const opt2 = opt1.cloneNode(true);
  toSel.appendChild(opt2);
});

// Default range
fromSel.value = uniqueDates[0];
toSel.value = uniqueDates[uniqueDates.length - 1];

// Rebuild on change
fromSel.onchange = () => filterSales(currentAdminFilter);
toSel.onchange   = () => filterSales(currentAdminFilter);
await filterSales('All');
}


async function filterSales(cat) {
  currentAdminFilter = cat;
  let sales = await getSalesOnce();
 
// âœ… SORT BY DATE (NEWEST FIRST)
sales.sort((a, b) => new Date(b.date) - new Date(a.date));

  const list = document.getElementById('salesList'); list.innerHTML = '';
  let grandTotal = 0;

  for (const s of sales) {
     if (currentAdminCashier !== 'All' && s.cashier !== currentAdminCashier) {
  continue;
}
    // âœ… Filter by DATE
// ---- Apply From-To Date Range ----
const fromStr = document.getElementById('adminDateFrom').value;
const toStr   = document.getElementById('adminDateTo').value;

const from = new Date(fromStr + ' 00:00');
const to   = new Date(toStr   + ' 23:59');

const saleD = new Date(new Date(s.date).toLocaleDateString());

if (saleD < from || saleD > to) continue;



// âœ… Filter by CATEGORY
let filtered = s.products;
if (cat !== 'All') {
  filtered = s.products.filter(p => p.category === cat);
}

    if (filtered.length === 0) continue;

    const div = document.createElement('div');
    div.style.borderBottom = '1px solid #e6f7ff';
    div.style.padding = '8px';
    div.style.marginBottom = '6px';

    

    const header = document.createElement('div');
header.style.display = 'flex';
header.style.justifyContent = 'space-between';

const title = document.createElement('strong');
title.innerText = `${new Date(s.date).toLocaleString()} - ${s.cashier}`;

const delBtn = document.createElement('button');
delBtn.innerText = 'X';
delBtn.className = 'small-x';

delBtn.onclick = async () => {
  if (!confirm('Delete this transaction?')) return;

  // restore stock
  const products = await getProductsOnce();


  for (const p of s.products) {
    const prod = products.find(pr =>
      pr.name === p.name && pr.category === p.category
    );
    if (prod) {
      await updateDoc(doc(db, 'products', prod.id), {
        stock: prod.stock + p.qty
      });
      productsCache = null;
    }
  }

  await deleteDoc(doc(db, 'sales', s.id));
  salesCache = null;
  await filterSales(currentAdminFilter);
};

header.appendChild(title);
header.appendChild(delBtn);
div.appendChild(header);


    let saleTotal = 0;
    filtered.forEach(p => {
      const line = document.createElement('div');
      line.innerText = `${p.name} (${p.qty}) [${p.category}] â‚±${p.qty * p.price}`;
      div.appendChild(line);
      saleTotal += (p.qty * p.price);
    });

    const totalLine = document.createElement('div');
    totalLine.style.marginTop = '6px';
    totalLine.style.fontWeight = '700';
    totalLine.innerText = `Transaction total: â‚±${saleTotal}`;
    div.appendChild(totalLine);

    grandTotal += saleTotal;
    list.appendChild(div);
  }
  
  // âœ… Filter by CASHIER



   document.getElementById('adminGrandTotal').innerText = `Total: â‚±${grandTotal}`;

}

/* ---------- CASHIER ---------- */
async function loadProducts() {
  await populateCategoryButtons();                // draw buttons first
  await filterCashierProducts(currentCashierCategory);  // keep current category
}


function populateCategoryButtons() {
  const container = document.getElementById('cashierCategoryButtons');
  container.innerHTML = '';

  fixedCategories.forEach(cat => {
    const btn = document.createElement('button');
    btn.innerText = cat;
    btn.className = 'cat-btn';

    if (cat === currentCashierCategory) {
      btn.classList.add('active-cat');
    }

    btn.onclick = async () => {
      currentCashierCategory = cat;
      await filterCashierProducts(cat);
      highlightActiveCategory();
    };

    container.appendChild(btn);
  });
}
function highlightActiveCategory() {
  const buttons = document.querySelectorAll('#cashierCategoryButtons button');
  buttons.forEach(btn => {
    if (btn.innerText === currentCashierCategory) {
      btn.classList.add('active-cat');
    } else {
      btn.classList.remove('active-cat');
    }
  });
}


async function filterCashierProducts(category) {
  let products = await getProductsOnce();
  if (category) products = products.filter(p => p.category === category);
  displayCashierProducts(products);
}


function displayCashierProducts(products) {
  const grid = document.getElementById('productGrid'); grid.innerHTML = '';
  products.forEach((p, i) => {
    grid.innerHTML += `<div class="product" onclick="openModal('${p.id}')"><div><strong>${p.name}</strong></div><div>â‚±${p.price}</div><div>Stock: ${p.stock}</div></div>`;
  });
if (customCategoryStatus[currentCashierCategory] !== false) {
  grid.innerHTML += `
    <div class="product custom-product" onclick="openCustomModal()">
      <div><strong>Custom Transaction</strong></div>
      <div>Tap to add</div>
    </div>
  `;
}
}

/* ---------- MODAL ---------- */
async function openModal(id) {
  modalProductIndex = id;
  document.getElementById('customNameDiv').style.display = 'none';

  const products = await getProductsOnce();
  const product = products.find(p => p.id === id);
  if (!product) return;

  if (product.stock <= 0) {
    alert('Out of stock!');
    return;
  }

  document.getElementById('modalName').innerText = product.name;
  document.getElementById('modalPrice').value = product.price;
  document.getElementById('modalQty').value = 1;

  document.getElementById('productModal').style.display = 'flex';
}


function openCustomModal() {
  modalProductIndex = null;
  document.getElementById('customNameDiv').style.display = 'block';
  document.getElementById('modalName').innerText = 'Custom Transaction';
  document.getElementById('modalPrice').value = 0;
  document.getElementById('modalQty').value = 1;
  document.getElementById('modalCustomName').value = '';
  document.getElementById('productModal').style.display = 'flex';
}

function closeModal() { document.getElementById('productModal').style.display = 'none'; }
function decreaseQty() { const el = document.getElementById('modalQty'); if (parseInt(el.value) > 1) el.value = parseInt(el.value) - 1; }
function increaseQty() { const el = document.getElementById('modalQty'); el.value = parseInt(el.value) + 1; }

async function modalAddToCart() {
  if (isAddingToCart) return;   // ðŸš« block spam clicks
  isAddingToCart = true;

  const addBtn = document.querySelector('#productModal button');
  addBtn.disabled = true;

  try {
    const qty = parseInt(document.getElementById('modalQty').value);
    const price = parseFloat(document.getElementById('modalPrice').value) || 0;
    let name, category;

    if (modalProductIndex === null) {
      name = document.getElementById('modalCustomName').value.trim() || 'Custom';
      category = currentCashierCategory;
    } else {
      const productRef = doc(db, 'products', modalProductIndex);
      const products = await getProductsOnce();
      const product = products.find(p => p.id === modalProductIndex);


      if (product.stock < qty) {
        alert('Not enough stock!');
        return;
      }

      // âœ… SAFE STOCK DECREMENT
      await updateDoc(productRef, {
        stock: product.stock - qty
      });

      name = product.name;
      category = product.category;
    }

    cart.push({ name, price, qty, category });
    renderCart();

    // reset modal
    document.getElementById('modalQty').value = 1;
    document.getElementById('modalPrice').value = 0;
    document.getElementById('modalCustomName').value = '';
    closeModal();

    if (!document.getElementById('cashierPage').classList.contains('hidden')) {
      await filterCashierProducts(currentCashierCategory);
      highlightActiveCategory();
    }

  } finally {
    isAddingToCart = false;
    addBtn.disabled = false;
  }
}


/* ---------- CART ---------- */
function renderCart() {
  const table = document.getElementById('cartTable');
  table.innerHTML = '<tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th>Remove</th></tr>';
  let total = 0;
  cart.forEach((p, i) => {
    const tr = document.createElement('tr');
    const subtotal = p.qty * p.price;
    total += subtotal;
    tr.innerHTML = `<td>${p.name}</td><td>${p.qty}</td><td>${p.price}</td><td>${subtotal}</td><td><button onclick="removeCartItem(${i})">X</button></td>`;
    table.appendChild(tr);
  });
  document.getElementById('cartTotal').innerText = total;
}

async function removeCartItem(i) {
  // ðŸš« Block spam clicking
  if (isRemovingItem[i]) return;
  isRemovingItem[i] = true;

  try {
    const item = cart[i];
    if (!item) return;

    if (item.name !== 'Custom') {
      const products = await getProductsOnce();
      const prod = products.find(p =>
  p.name === item.name && p.category === item.category
);


      if (prodDoc) {
        await updateDoc(
          doc(db, 'products', prodDoc.id),
          { stock: prodDoc.data().stock + item.qty }
        );
      }
    }

    cart.splice(i, 1);
    renderCart();
    await loadProducts();

  } finally {
    delete isRemovingItem[i];
  }
}


async function checkout() {
  if (cart.length === 0) return alert('Cart empty');

  const now = new Date();

  // âœ… MERGE DUPLICATE ITEMS
  const merged = {};
  for (const item of cart) {
    const key = item.name + "_" + item.category;
    if (!merged[key]) {
      merged[key] = { ...item };
    } else {
      merged[key].qty += item.qty;
    }
  }

  const productsCopy = Object.values(merged);

  let saleTotal = 0;
  productsCopy.forEach(p => {
    saleTotal += (p.qty * p.price);
  });

  await addDoc(collection(db, 'sales'), {
    cashier: currentUser.name,
    date: now.toISOString(),
    products: productsCopy,
    total: saleTotal
  });
  salesCache = null;
  cart = [];
  renderCart();
  await loadDailySales();
  await loadSales();

  alert('Transaction saved!');
}


/* ---------- DAILY SALES ---------- */
async function loadDailySales() {
  let sales = await getSalesOnce();

// âœ… SORT BY DATE (NEWEST FIRST)
sales.sort((a, b) => new Date(b.date) - new Date(a.date));

  const list = document.getElementById('dailySalesList'); list.innerHTML = '';
  document.getElementById('dailyTotalBox').innerText = 'Daily Total: â‚±0';
  const today = new Date().toLocaleDateString();
  const daily = sales.filter(s => new Date(s.date).toLocaleDateString() === today && s.cashier === currentUser.name);

  let dailyTotal = 0;
  for (const s of daily) {
    const div = document.createElement('div');
    div.style.borderBottom = '1px solid #eaf6ff';
    div.style.padding = '8px';
    div.style.marginBottom = '6px';

    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.justifyContent = 'space-between';
    header.style.alignItems = 'center';

    const title = document.createElement('strong');
    title.innerText = `${new Date(s.date).toLocaleString()}   ${s.cashier}`;


    const delBtn = document.createElement('button');
    delBtn.className = 'small-x';
    delBtn.innerText = 'X';
    delBtn.onclick = async () => {
      if (confirm('Delete this transaction?')) {
        // increment stock back
        const products = await getProductsOnce();
        for (const pItem of s.products) {
          const prod = products.find(pr => pr.name === pItem.name && pr.category === pItem.category);
          if (prod) await updateDoc(doc(db, 'products', prod.id), { stock: prod.stock + pItem.qty });
          productsCache = null;
        }
        await deleteDoc(doc(db, 'sales', s.id));
        salesCache = null;
        await loadDailySales();
        await loadSales();
        await loadProducts();
      }
    };

    header.appendChild(title);
    header.appendChild(delBtn);
    div.appendChild(header);

    let saleTotal = 0;
    s.products
  .filter(p => currentDailyCategory === 'All' || p.category === currentDailyCategory)
  .forEach(p => {
    const pdiv = document.createElement('div');
    pdiv.innerText = `${p.name} (${p.qty}) [${p.category}] â‚±${p.qty * p.price}`;
    div.appendChild(pdiv);
    saleTotal += (p.qty * p.price);
  });
// Skip this transaction if nothing matched the category
   if (saleTotal === 0 && currentDailyCategory !== 'All') {
       continue;
   }
    const totLine = document.createElement('div');
    totLine.style.fontWeight = '700';
    totLine.style.marginTop = '6px';
    totLine.innerText = `Transaction total: â‚±${saleTotal}`;
    div.appendChild(totLine);

    dailyTotal += saleTotal;
    list.appendChild(div);
  }

  
  
  document.getElementById('dailyTotalBox').innerText = `Daily Total: â‚±${dailyTotal}`;
   buildDailyCategoryButtons();
}

function buildDailyCategoryButtons() {
  const container = document.getElementById('dailyCategoryButtons');
  container.innerHTML = '';

  const categories = ['All', 'Sportswear', 'Silver', 'Indu'];

  categories.forEach(cat => {
    const btn = document.createElement('button');
    btn.innerText = cat;
    btn.style.marginRight = "6px";

    if (cat === currentDailyCategory) {
      btn.classList.add('active-cat');
    }

    btn.onclick = async () => {
      currentDailyCategory = cat;
      await loadDailySales();
      buildDailyCategoryButtons();
    };

    container.appendChild(btn);
  });
}


async function openSalesHistory() {
   // ðŸ”„ RESET DATE DROPDOWNS
document.getElementById('historyDateFrom').removeAttribute('data-filled');
document.getElementById('historyDateFrom').innerHTML = '';
document.getElementById('historyDateTo').innerHTML = '';

  isViewingReport = false;
document.getElementById('sales-history-dd').style.display = 'flex';
  document.getElementById('historyDateFrom').disabled = false;
  document.getElementById('historyDateTo').disabled = false;
  document.getElementById('addExpenseBtn').style.display = 'inline-block';
  document.getElementById('makeReportBtn').style.display = 'inline-block';

  document.getElementById('salesHistoryModal').style.display = 'flex';
  await buildSalesHistory();
}


function closeSalesHistory() {
  isViewingReport = false;
  document.getElementById('salesHistoryModal').style.display = 'none';
  document.getElementById("List-txt").innerText = "";
}


async function buildSalesHistory() {
  const sales = (await getSalesOnce())
  .filter(s => s.cashier === currentUser.name);

// ðŸ”’ Get reported dates for cashier
const repDocSnap = await getDocs(collection(db, 'reported_dates'));
const repDoc = repDocSnap.docs.find(d => d.id === currentUser.name);

const reportedDates = repDoc ? repDoc.data().dates || [] : [];

  const fromSel = document.getElementById('historyDateFrom');
  const toSel = document.getElementById('historyDateTo');
  const tbody = document.querySelector('#historyTable tbody');
  const totalsBox = document.getElementById('historyTotals');

  tbody.innerHTML = '';

  // âœ… Create unique date list FIRST
  const dates = [...new Set(
    sales.map(s => new Date(s.date).toLocaleDateString()).filter(d => !reportedDates.includes(d)) // âœ… hide reported dates
  )].sort((a,b)=> new Date(a) - new Date(b));

  if (dates.length === 0) {
    totalsBox.innerText = 'No sales data';
    return;
  }

  // âœ… Fill dropdowns only once
  if (!fromSel.dataset.filled) {
    fromSel.innerHTML = '';
    toSel.innerHTML = '';

    dates.forEach(d => {
      const opt1 = document.createElement('option');
      opt1.value = d;
      opt1.innerText = d;

      const opt2 = opt1.cloneNode(true);
      fromSel.appendChild(opt1);
      toSel.appendChild(opt2);
    });

    fromSel.value = dates[0];
    toSel.value   = dates[dates.length - 1];

    fromSel.dataset.filled = 'true';

    // âœ… Attach change events once
    fromSel.onchange = buildSalesHistory;
    toSel.onchange   = buildSalesHistory;
  }

  const fromDate = new Date(fromSel.value);
  const toDate   = new Date(toSel.value);
  toDate.setHours(23, 59, 59, 999);
  


  const map = {};
  let grandTotal = 0;
  let totSilver = 0, totSport = 0, totIndu = 0;

  
   // âœ… LOAD EXPENSES (NO DATE FILTER â€“ FIXED)
const expenseListDiv = document.getElementById('expenseList');
expenseListDiv.innerHTML = '';

const expenses = (await getExpensesOnce())
  .filter(e => e.cashier === currentUser.name);

if (expenses.length === 0) {
  document.getElementById("List-txt").innerText = "No Expenses";
} else {
  document.getElementById("List-txt").innerText = "Expenses List:";
}

let totalExpenses = 0;

expenses.forEach(e => {
  const div = document.createElement('div');
  div.style.padding = '6px';
  div.style.borderBottom = '1px solid #e6f7ff';
  div.style.display = 'flex';
  div.style.justifyContent = 'space-between';

  const text = document.createElement('span');
  text.innerText = `${e.description}: â‚±${e.amount}`;
  div.appendChild(text);

  const delBtn = document.createElement('button');
  delBtn.innerText = 'X';
  delBtn.style.background = 'var(--danger)';
  delBtn.style.color = '#fff';
  delBtn.style.border = 'none';
  delBtn.style.borderRadius = '4px';
  delBtn.style.padding = '2px 6px';

  delBtn.onclick = async () => {
    if (!confirm('Delete this expense?')) return;
    await deleteDoc(doc(db, 'expenses', e.id));
    expensesCache = null;
    await buildSalesHistory();
  };

  div.appendChild(delBtn);
  expenseListDiv.appendChild(div);

  totalExpenses += e.amount;
});

   
  sales.forEach(s => {
    const d = new Date(s.date);
    const key = d.toLocaleDateString();

    if (d < fromDate || d > toDate) return;

    if (!map[key]) {
      map[key] = { Silver: 0, Sportswear: 0, Indu: 0 };
    }

    s.products.forEach(p => {
      if (map[key][p.category] !== undefined) {
        const val = p.qty * p.price;
        map[key][p.category] += val;
      }
    });
  });

  Object.keys(map).sort((a,b)=> new Date(a)-new Date(b)).forEach(date => {
    const silver = map[date].Silver;
    const sport = map[date].Sportswear;
    const indu  = map[date].Indu;
    const rowTotal = silver + sport + indu;

    totSilver += silver;
    totSport  += sport;
    totIndu   += indu;
    grandTotal += rowTotal;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="padding:8px;border:1px solid #cfe9ff;">${date}</td>
      <td style="padding:8px;border:1px solid #cfe9ff;">${silver}</td>
      <td style="padding:8px;border:1px solid #cfe9ff;">${sport}</td>
      <td style="padding:8px;border:1px solid #cfe9ff;">${indu}</td>
    `;
    tbody.appendChild(row);
  });

  // âœ… Totals row
  const totalRow = document.createElement('tr');
  totalRow.style.fontWeight = 'bold';
  totalRow.innerHTML = `
    <td style="padding:8px;border:1px solid #cfe9ff;">Total</td>
    <td style="padding:8px;border:1px solid #cfe9ff;">${totSilver}</td>
    <td style="padding:8px;border:1px solid #cfe9ff;">${totSport}</td>
    <td style="padding:8px;border:1px solid #cfe9ff;">${totIndu}</td>
  `;
  tbody.appendChild(totalRow);

// Load Expenses
if (expenses.length == 0){
   if(isViewingReport){
   document.getElementById("List-txt").innerText = "Expenses List:"
   }
   document.getElementById("List-txt").innerText = "No Expenses"
} else{
   document.getElementById("List-txt").innerText = "Expenses List:"
}
   





// âœ… Final totals
totalsBox.innerText = `Grand Total: â‚±${grandTotal}\nExpenses: â‚±${totalExpenses}\nNet: â‚±${grandTotal - totalExpenses}`;


}

async function makeReport() {
  const from = document.getElementById('historyDateFrom').value;
  const to   = document.getElementById('historyDateTo').value;

  const sales = (await getSalesOnce()).filter(s =>
  s.cashier === currentUser.name &&
  new Date(s.date) >= new Date(from) &&
  new Date(s.date) <= new Date(to + ' 23:59')
);


  if (sales.length === 0) {
    alert('No sales to report');
    return;
  }

  const expenses = (await getExpensesOnce())
  .filter(e => e.cashier === currentUser.name);


  let grandTotal = 0;
  sales.forEach(s => grandTotal += s.total);

  let totalExpenses = 0;
  expenses.forEach(e => totalExpenses += e.amount);

  const net = grandTotal - totalExpenses;

  // SAVE REPORT
  await addDoc(collection(db, 'reports'), {
    cashier: currentUser.name,
    fromDate: from,
    toDate: to,
    sales,
    expenses,
    grandTotal,
    totalExpenses,
    net,
    createdAt: new Date()
  });

  // MARK SALES AS REPORTED
  const dateRange = [];
sales.forEach(s => {
  const d = new Date(s.date).toLocaleDateString();
  if (!dateRange.includes(d)) dateRange.push(d);
});

const repRef = doc(db, 'reported_dates', currentUser.name);

// get existing reported dates
const repSnap = await getDocs(collection(db, 'reported_dates'));
const repDoc = repSnap.docs.find(d => d.id === currentUser.name);

let existingDates = [];
if (repDoc && repDoc.data().dates) {
  existingDates = repDoc.data().dates;
}

// merge old + new (no duplicates)
const mergedDates = [...new Set([...existingDates, ...dateRange])];

await setDoc(repRef, {
  dates: mergedDates
});



  alert('Report saved!');
  // ðŸ§¹ CLEAR EXPENSES AFTER REPORT
const expSnap = await getDocs(collection(db, 'expenses'));
for (const d of expSnap.docs) {
  if (d.data().cashier === currentUser.name) {
    await deleteDoc(doc(db, 'expenses', d.id));
    expensesCache = null;
  }
}

  closeSalesHistory();
}



/* ---------- INIT ---------- */


// ===== SAFE ONE-TIME FETCHERS =====
async function getProductsOnce(force = false) {
  if (productsCache && !force) return productsCache;
  const snap = await getDocs(collection(db, 'products'));
  productsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  return productsCache;
}

async function getSalesOnce(force = false) {
  if (salesCache && !force) return salesCache;
  const snap = await getDocs(collection(db, 'sales'));
  salesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  return salesCache;
}

async function getExpensesOnce(force = false) {
  if (expensesCache && !force) return expensesCache;
  const snap = await getDocs(collection(db, 'expenses'));
  expensesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  return expensesCache;
}

async function getCashiersOnce(force = false) {
  if (cashiersCache && !force) return cashiersCache;
  const snap = await getDocs(collection(db, 'cashiers'));
  cashiersCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  return cashiersCache;
}



(async function initOnLoad() {
  // Firestore collections auto-created; nothing needed here
})();
document.addEventListener('DOMContentLoaded', async () => {
  const savedUser = localStorage.getItem('loggedInUser');
  if (!savedUser) return;

  currentUser = JSON.parse(savedUser);

  if (currentUser.role === 'admin') {
    document.getElementById('login').classList.add('hidden');
    document.getElementById('adminPage').classList.remove('hidden');
    showSection('inventory');
    await loadInventory();
    await loadCashiers();
    await loadSales();
  }

  if (currentUser.role === 'cashier') {
    document.getElementById('login').classList.add('hidden');
    document.getElementById('cashierPage').classList.remove('hidden');
    document.getElementById('cashierNameDisplay').innerText = currentUser.name;
    await loadSettings();
    await loadProducts();
    await loadDailySales();
  }
});


const themeToggle = document.getElementById('themeToggle');

 themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-theme');
  
  if(document.body.classList.contains('dark-theme')) {
    themeToggle.innerText = 'â˜€ï¸ Light Mode';
    localStorage.setItem('theme', 'dark');
  } else {
    themeToggle.innerText = 'ðŸŒ™ Dark Mode';
    localStorage.setItem('theme', 'light');
  }
});

// âœ… Load saved theme on page load
const savedTheme = localStorage.getItem('theme');
if(savedTheme === 'dark') {
  document.body.classList.add('dark-theme');
  themeToggle.innerText = 'â˜€ï¸Light Mode';
}


function openReportPassword() {
  document.getElementById('reportPassword').value = '';
  document.getElementById('reportPasswordModal').style.display = 'flex';
}



function closeReportPassword() {
  document.getElementById('reportPasswordModal').style.display = 'none';
}

async function confirmMakeReport() {
  const entered = document.getElementById('reportPassword').value;

  // verify cashier password
  const cashiers = await getCashiersOnce();
  const cashier = cashiers.find(c => c.username === currentUser.name);


  if (!cashier || cashier.password !== entered) {
    alert('Incorrect password');
    return;
  }

  closeReportPassword();
  await makeReport();
}

function openExpenseModal() {
  document.getElementById('expenseDesc').value = '';
  document.getElementById('expenseAmount').value = '';
  document.getElementById('expenseModal').style.display = 'flex';
}

function closeExpenseModal() {
  document.getElementById('expenseModal').style.display = 'none';
}

async function saveExpense() {
  const desc = document.getElementById('expenseDesc').value.trim();
  const amt = parseFloat(document.getElementById('expenseAmount').value);

  if (!desc) {
    alert('Please enter description');
    return;
  }

  if (isNaN(amt) || amt <= 0) {
    alert('Please enter a valid amount');
    return;
  }

  await addDoc(collection(db, 'expenses'), {
    cashier: currentUser.name,
    description: desc,
    amount: amt,
    date: new Date().toISOString()
  });

  expensesCache = null;
  closeExpenseModal();
  await buildSalesHistory();
}


async function loadReports() {
  const snap = await getDocs(collection(db, 'reports'));

  // ðŸ”½ Convert to array + sort by createdAt (NEWEST FIRST)
  const reports = snap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .sort((a, b) => {
      const aTime = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
      const bTime = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
      return bTime - aTime;
    });

  const list = document.getElementById('reportList');
  list.innerHTML = '';

  reports.forEach(r => {
    const created = r.createdAt?.toDate
      ? r.createdAt.toDate()
      : new Date(r.createdAt);

    const div = document.createElement('div');
    div.style.background = 'var(--card)';
    div.style.padding = '12px';
    div.style.borderRadius = '10px';
    div.style.boxShadow = '0 2px 6px rgba(0,0,0,0.06)';
    div.style.marginBottom = '10px';

    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>Cashier:</strong> ${r.cashier}<br>
          <span>${r.fromDate} - ${r.toDate}</span><br>
          <small style="color:gray;">
            Submitted: ${created.toLocaleString()}
          </small>
        </div>
        <button onclick="viewReport('${r.id}')">View</button>
      </div>
    `;

    list.appendChild(div);
  });
}

async function viewReport(id) {
  isViewingReport = true;

  const snap = await getDocs(collection(db, 'reports'));
  const reportDoc = snap.docs.find(d => d.id === id);
  if (!reportDoc) return alert('Report not found');

  const report = reportDoc.data();

  document.getElementById('salesHistoryModal').style.display = 'flex';

  // Disable controls
  document.getElementById('sales-history-dd').style.display = 'none';
  document.getElementById('historyDateFrom').disabled = true;
  document.getElementById('historyDateTo').disabled = true;
  document.getElementById('addExpenseBtn').style.display = 'none';
  document.getElementById('makeReportBtn').style.display = 'none';
  
  // Clear UI
  document.querySelector('#historyTable tbody').innerHTML = '';
  document.getElementById('expenseList').innerHTML = '';

  // Build table from REPORT DATA
  const tbody = document.querySelector('#historyTable tbody');
  const map = {};

  report.sales.forEach(s => {
    const date = new Date(s.date).toLocaleDateString();
    if (!map[date]) map[date] = { Silver: 0, Sportswear: 0, Indu: 0 };

    s.products.forEach(p => {
      map[date][p.category] += p.qty * p.price;
    });
  });

  Object.keys(map).forEach(date => {
    const r = map[date];
    const tr = document.createElement('tr');
    tr.innerHTML = `
       <td style="padding:8px;border:1px solid #cfe9ff;">${date}</td>
      <td style="padding:8px;border:1px solid #cfe9ff;">${r.Silver}</td>
      <td style="padding:8px;border:1px solid #cfe9ff;">${r.Sportswear}</td>
      <td style="padding:8px;border:1px solid #cfe9ff;">${r.Indu}</td>
    `;
    tbody.appendChild(tr);
  });

  // Expenses (READ-ONLY)
  let totalExpenses = 0;
  report.expenses.forEach(e => {
    const div = document.createElement('div');
    div.innerText = `${e.description}: â‚±${e.amount}`;
    document.getElementById('expenseList').appendChild(div);
    totalExpenses += e.amount;
  });

  document.getElementById('historyTotals').innerText =
    `Grand Total: â‚±${report.grandTotal}
Expenses: â‚±${report.totalExpenses}
Net: â‚±${report.net}`;
}




// Expose functions to global scope for HTML onclick
window.login = login;
window.logout = logout;
window.showSection = showSection;
window.toggleAddProduct = toggleAddProduct;
window.addProduct = addProduct;
window.addCashier = addCashier;
window.deleteCashier = deleteCashier;
window.editCashier = editCashier;
window.openModal = openModal;
window.openCustomModal = openCustomModal;
window.closeModal = closeModal;
window.decreaseQty = decreaseQty;
window.increaseQty = increaseQty;
window.modalAddToCart = modalAddToCart;
window.removeCartItem = removeCartItem;
window.checkout = checkout;
window.openSalesHistory = openSalesHistory;
window.closeSalesHistory = closeSalesHistory;
window.managePanel = managePanel;
window.editProduct = editProduct;
window.closeEditModal = closeEditModal;
window.saveEditProduct = saveEditProduct;
window.openReportPassword = openReportPassword;
window.closeReportPassword = closeReportPassword;
window.confirmMakeReport = confirmMakeReport;
window.viewReport = viewReport;
window.openExpenseModal = openExpenseModal;
window.closeExpenseModal = closeExpenseModal;
window.saveExpense = saveExpense;
</script>
</body>
</html>
